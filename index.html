<!DOCTYPE html>
<html lang="vi"> 
<head>
    <meta charset="UTF-8">
    <!-- Thêm viewport-fit=cover để hỗ trợ tai thỏ trên iPhone -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ứng dụng Thời tiết</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi4buWbmcgZOG7pW5nIFRo4budaSB0aeG6v3QiLCJzaG9ydF9uYW1lIjoiVGjhu5WpIHRp4bq6dCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMyNTYzZWIiLCJkZXNjcmlwdGlvbiI6IkThu7Egw6FvIHRo4budaSB0aeG6v3QgY2jDrW5oIHjDoWMiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvNDA1Mi80MDUyOTg0LnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifSx7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzQwNTIvNDA1Mjk4NC5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    
    <!-- --- CROSS-PLATFORM THEME CONFIG --- -->
    
    <!-- 1. Modern Browsers (Android, Chrome/Edge on Windows/macOS) -->
    <!-- ID để JS cập nhật màu động -->
    <meta id="meta-theme-color" name="theme-color" content="#f9fafb">

    <!-- 2. iOS (iPhone/iPad) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- black-translucent: Nội dung tràn lên status bar (tạo hiệu ứng trong suốt) -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Thời tiết">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4052/4052984.png">

    <!-- 3. Windows (Start Menu Tiles) -->
    <meta name="application-name" content="Ứng dụng Thời tiết">
    <!-- ID để JS cập nhật màu động -->
    <meta id="meta-tile-color" name="msapplication-TileColor" content="#2563eb">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="msapplication-TileImage" content="https://cdn-icons-png.flaticon.com/512/4052/4052984.png">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --font-main: 'Google Sans Flex', sans-serif;
            --text-color: #1e293b;
            --text-light: #ffffff;
            --text-muted: #475569;
            --bg-glass: rgba(255, 255, 255, 0.35);
            --bg-glass-hover: rgba(255, 255, 255, 0.45);
            --bg-item: rgba(255, 255, 255, 0.2);
            --bg-item-hover: rgba(255, 255, 255, 0.4);
            --bg-active: rgba(255, 255, 255, 0.6);
            --border-color: rgba(255, 255, 255, 0.3);
            --shadow-color: rgba(31, 38, 135, 0.1);
            --input-bg: rgba(255, 255, 255, 0.9);
            --accent-blue: #2563eb;
            
            /* Safe area for iPhone Notch */
            --safe-top: env(safe-area-inset-top, 0px);
        }

        html.dark {
            --text-color: #e2e8f0;
            --text-muted: #94a3b8;
            --bg-glass: rgba(30, 41, 59, 0.5);
            --bg-glass-hover: rgba(30, 41, 59, 0.65);
            --bg-item: rgba(0, 0, 0, 0.2);
            --bg-item-hover: rgba(0, 0, 0, 0.3);
            --bg-active: rgba(255, 255, 255, 0.15);
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(30, 41, 59, 0.9);
            --accent-blue: #60a5fa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-main);
            color: var(--text-color);
            transition: background 1s ease-in-out, color 0.3s;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
            /* Padding bottom for scroll space */
            padding-bottom: 2rem;
            /* Quan trọng cho iOS PWA: Đảm bảo nền full màn hình */
            background-attachment: fixed; 
        }

        img { max-width: 100%; display: block; }

        /* --- BACKGROUNDS --- */
        .weather-default { background: linear-gradient(to top, #d2d6db, #f9fafb); }
        html.dark .weather-default { background: linear-gradient(to top, #334155, #0f172a); }
        .weather-sun-light { background: linear-gradient(180deg, #FFF9C4 0%, #E1F5FE 100%); }
        .weather-sun-intense { background: linear-gradient(180deg, #FFB300 0%, #FFECB3 100%); }
        .weather-cloudy-grey { background: linear-gradient(180deg, #78909C 0%, #CFD8DC 100%); }
        .weather-rain-day { background: linear-gradient(180deg, #42A5F5 0%, #BBDEFB 100%); }
        .weather-rain-night { background: linear-gradient(180deg, #1A237E 0%, #000000 100%); }
        .weather-night-clear { background: linear-gradient(180deg, #0D47A1 0%, #1565C0 100%); }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-blue { color: #3b82f6; }
        .text-orange { color: #f97316; }
        .text-green { color: #22c55e; }
        .text-yellow { color: #eab308; }
        .text-purple { color: #c084fc; }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(150, 150, 150, 0.4); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(150, 150, 150, 0.6); }

        /* --- LAYOUT CONTAINER --- */
        .container { max-width: 1400px; margin: 0 auto; position: relative; z-index: 10; padding: 0 1rem; width: 100%; }

        /* --- HEADER --- */
        .main-header {
            position: fixed; inset: 0; z-index: 50; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; transition: all 0.3s;
            /* iOS Safe Area support */
            padding-top: max(1.5rem, var(--safe-top)); 
        }
        .header-clock-area {
            pointer-events: auto; display: flex; justify-content: center; align-items: center; gap: 0.75rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .clock-time { font-size: 1.8rem; font-weight: bold; color: white; }
        .clock-date { font-size: 0.9rem; color: rgba(255,255,255,0.9); font-weight: 500; }
        .clock-sep { color: rgba(255,255,255,0.6); font-size: 1.25rem; }
        
        .header-controls {
            pointer-events: auto; padding: 1rem 1rem 1.5rem 1rem; width: 100%; display: flex; align-items: center; gap: 0.75rem;
            background: transparent;
        }
        
        .controls-center { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; }
        .controls-right { flex: 0 0 auto; }

        .btn-circle {
            flex: 0 0 48px; width: 48px; height: 48px; border-radius: 50%;
            background: var(--input-bg); border: none; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); backdrop-filter: blur(4px);
            transition: transform 0.2s; color: var(--text-color);
        }
        .btn-circle.primary { color: var(--accent-blue); }
        .btn-circle:hover { transform: scale(1.1); }
        
        .search-wrapper { flex: 1; position: relative; width: auto; }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; }
        
        .search-spinner {
            position: absolute; right: 1rem; top: 50%; width: 1.25rem; height: 1.25rem;
            border: 2px solid #e2e8f0; border-top-color: var(--accent-blue); border-radius: 50%;
            animation: spin-centered 0.8s linear infinite; pointer-events: none;
        }
        @keyframes spin-centered {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }

        .search-input {
            width: 100%; background: var(--input-bg); color: var(--text-color);
            border: none; border-radius: 9999px; padding: 0.75rem 3rem 0.75rem 3rem;
            font-size: 1rem; outline: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); backdrop-filter: blur(4px);
        }
        
        .suggestions-box {
            position: absolute; width: 100%; background: var(--input-bg);
            border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            backdrop-filter: blur(12px); border: 1px solid var(--border-color);
            z-index: 100; bottom: 100%; margin-bottom: 0.75rem; max-height: 300px; overflow-y: auto;
        }

        @media (min-width: 768px) {
            .main-header {
                position: sticky; top: 0; z-index: 90;
                background: transparent; backdrop-filter: none; -webkit-backdrop-filter: none;
                border-bottom: none; box-shadow: none;
                width: calc(100% + 2rem); margin: 0 -1rem 1.5rem -1rem; padding: 1rem 2rem;
                height: auto; display: grid; grid-template-columns: 1fr 2fr 1fr; align-items: center; gap: 1rem;
                pointer-events: auto;
                padding-top: 1rem; /* Reset top padding on desktop */
            }
            .header-clock-area { justify-content: flex-start; display: block; text-align: left; }
            .clock-time { font-size: 2rem; display: block; }
            .clock-sep { display: none; }
            .header-controls { padding: 0; display: contents; background: none; }
            .controls-center { grid-column: 2; justify-content: center; width: 100%; display: flex; align-items: center; gap: 0.75rem; }
            .controls-right { grid-column: 3; display: flex; justify-content: flex-end; }
            .search-wrapper { max-width: 28rem; }
            .suggestions-box { bottom: auto; top: 100%; margin-top: 0.5rem; margin-bottom: 0; } 
            body { padding-top: 0; }
        }

        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); font-size: 0.875rem; }
        .suggestion-item:hover { background: var(--bg-glass-hover); }

        .main-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; padding-top: 4rem; width: 100%; }
        @media (min-width: 1024px) { .main-grid { grid-template-columns: 1fr 1fr; padding-top: 0; } }
        .col-left, .col-right { display: flex; flex-direction: column; gap: 1.5rem; min-width: 0; }

        .glass-panel {
            background: var(--bg-glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 var(--shadow-color);
            border-radius: 2rem; padding: 1.5rem; transition: all 0.3s ease; width: 100%;
        }
        .glass-panel:hover { transform: translateY(-2px); background: var(--bg-glass-hover); border-color: rgba(255,255,255,0.6); }
        html.dark .glass-panel:hover { border-color: rgba(255,255,255,0.2); }
        
        .glass-item { background: var(--bg-item); border: 1px solid var(--border-color); border-radius: 1rem; transition: transform 0.2s, background 0.2s, border-color 0.2s; }
        .glass-item:hover { background: var(--bg-item-hover); transform: scale(1.02); }

        .section-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; }
        .section-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .location-title { font-size: 2rem; font-weight: 700; line-height: 1.2; text-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; }
        .location-subtitle { color: var(--text-muted); font-weight: 500; margin-top: 0.25rem; transition: color 0.3s; }
        .current-weather-display { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; margin-top: 1rem; flex-wrap: wrap; }
        .weather-icon-lg { width: 7rem; height: 7rem; filter: drop-shadow(0 10px 8px rgba(0,0,0,0.1)); }
        .temp-display { font-size: 4.5rem; font-weight: 700; line-height: 1; }
        .condition-display { font-size: 1.25rem; font-weight: 500; color: var(--text-muted); margin-top: 0.5rem; }
        
        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (min-width: 768px) { .grid-stats { grid-template-columns: repeat(4, 1fr); } }
        .stat-card { padding: 0.75rem; display: flex; align-items: center; gap: 0.75rem; overflow: hidden; }
        .stat-label { font-size: 0.75rem; opacity: 0.7; white-space: nowrap; }
        .stat-value { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .scroll-container { display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 1rem; cursor: grab; max-width: 100%; width: 100%; scroll-behavior: smooth; }
        .scroll-container:active { cursor: grabbing; }
        .hourly-card { flex: 0 0 auto; min-width: 6rem; padding: 0.75rem; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .daily-list { display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.5rem; max-width: 100%; width: 100%; }
        .daily-card { flex: 0 0 auto; padding: 0.75rem; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; min-width: 180px; cursor: pointer; position: relative; }
        .daily-card.active { background: var(--bg-active); border-color: var(--text-light); box-shadow: 0 0 15px rgba(255,255,255,0.2); transform: scale(1.03); }
        
        @media (min-width: 1024px) {
            .daily-forecast-section { height: 400px; display: flex; flex-direction: column; }
            .daily-list { flex-direction: column; overflow-y: auto; overflow-x: hidden; padding-right: 0.5rem; flex: 1; }
            .daily-card { width: 100%; min-width: 0; }
        }

        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (min-width: 768px) { .details-grid { grid-template-columns: repeat(4, 1fr); } }
        .detail-box { padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; border-radius: 1rem; }
        .detail-box-header { display: flex; items-center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .detail-box-value { font-size: 1.5rem; font-weight: bold; }

        .map-section { display: flex; flex-direction: column; height: 350px; }
        .map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .map-frame { width: 100%; flex: 1; border-radius: 0.75rem; border: none; background: #cbd5e1; }
        .btn-link { background: none; border: none; color: var(--accent-blue); font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); z-index: 100; display: flex; flex-direction: column; transition: opacity 0.3s; }
        html.dark .modal-overlay { background: rgba(15, 23, 42, 0.9); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .modal-content { flex: 1; padding: 1rem; overflow: hidden; }
        .full-map { width: 100%; height: 100%; border-radius: 1rem; border: none; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

        .settings-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; display: flex; }
        .settings-menu { position: absolute; right: 1rem; bottom: 6rem; width: 18rem; background: var(--input-bg); backdrop-filter: blur(20px); border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); padding: 1.25rem; border: 1px solid rgba(255,255,255,0.2); }
        @media (min-width: 768px) { .settings-menu { bottom: auto; top: 6rem; } }
        .menu-btn { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.75rem; background: transparent; border: none; color: var(--text-color); cursor: pointer; transition: background 0.2s; }
        .menu-btn:hover { background: var(--bg-glass-hover); }
        .menu-btn-content { display: flex; align-items: center; gap: 0.75rem; }

        .toast { position: fixed; top: 1.5rem; right: 1.5rem; background: rgba(239, 68, 68, 0.9); color: white; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 110; display: flex; align-items: center; backdrop-filter: blur(4px); }
        .spinner { width: 2rem; height: 2rem; border: 3px solid transparent; border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- WEATHER EFFECTS --- */
        #weather-effects-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; overflow: hidden; }
        
        .rain-drop { position: absolute; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.6)); width: 1px; height: 20px; top: -25px; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }
        
        .thunder-flash { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.5); opacity: 0; animation: flash 0.4s ease-out; }
        @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        .lightning-bolt {
            position: absolute;
            width: 80px; height: 120px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFEB3B"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>') no-repeat center center;
            background-size: contain;
            opacity: 0; transform: scale(0);
            filter: drop-shadow(0 0 15px rgba(255, 235, 59, 0.9));
            pointer-events: none;
        }
        @keyframes strike {
            0% { opacity: 0; transform: scale(0.8) skewX(-10deg); }
            10% { opacity: 1; transform: scale(1.2) skewX(-10deg); }
            20% { opacity: 0; }
            30% { opacity: 1; transform: scale(1.2) skewX(-10deg); }
            100% { opacity: 0; transform: scale(0.8) skewX(-10deg); }
        }
        
        .sun-beam { position: absolute; top: -20%; right: -20%; width: 80vw; height: 80vw; background: radial-gradient(circle, rgba(255,255,220,0.3) 0%, rgba(255,255,255,0) 60%); animation: sun-pulse 6s ease-in-out infinite alternate; }
        @keyframes sun-pulse { from { opacity: 0.3; transform: scale(1); } to { opacity: 0.6; transform: scale(1.1); } }
        .sun-glare { position: absolute; top: -150px; right: -150px; width: 800px; height: 800px; background: repeating-conic-gradient(from 0deg, rgba(255,255,255,0) 0deg, rgba(255,255,255,0.15) 5deg, rgba(255,255,255,0) 10deg); animation: sun-rotate 30s linear infinite; border-radius: 50%; }
        .sun-core { position: absolute; top: 50px; right: 50px; width: 100px; height: 100px; background: radial-gradient(circle, #fff 20%, rgba(255,220,100,0.8) 60%, transparent 100%); filter: blur(15px); animation: sun-pulse 2s infinite alternate; }
        @keyframes sun-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        .weather-icon { width: 100%; height: 100%; opacity: 0; transition: opacity 0.3s ease; }
        .weather-icon.loaded { opacity: 1; }
        .delay-100 { animation-delay: 0.1s; } .delay-200 { animation-delay: 0.2s; } .delay-300 { animation-delay: 0.3s; } .delay-400 { animation-delay: 0.4s; } .delay-500 { animation-delay: 0.5s; }
        .modal-entering { animation: modalZoomIn 0.2s ease-out forwards; }
        .modal-exiting { animation: modalZoomOut 0.2s ease-out forwards; }
        @keyframes modalZoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes modalZoomOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
    </style>
</head>

<body class="weather-default">

    <div id="weather-effects-container"></div>

    <div class="container">
        <header class="main-header">
            <div class="header-clock-area">
                <div id="header-clock" class="clock-time">00:00</div>
                <span class="clock-sep">|</span>
                <div id="header-date" class="clock-date">Đang tải...</div>
            </div>
            <div class="header-controls">
                <div class="controls-center">
                    <button id="detect-location-button" class="btn-circle primary"><span class="material-symbols-rounded">my_location</span></button>
                    <form id="search-form" class="search-wrapper">
                        <div style="position: relative;">
                            <div class="search-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg></div>
                            <input type="text" id="search-input" placeholder="Tìm kiếm..." class="search-input">
                            <div id="search-loading" class="search-spinner hidden"></div>
                        </div>
                        <div id="search-suggestions" class="suggestions-box hidden"></div>
                    </form>
                </div>
                <div class="controls-right">
                    <button id="settings-button" class="btn-circle"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m3-6h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5" /></svg></button>
                </div>
            </div>
        </header>

        <main class="main-grid">
            <div class="col-left">
                <section id="current-info-section" class="glass-panel animate-slide-up delay-100">
                    <div class="section-header">
                        <div style="width: 100%;">
                            <h1 id="current-location" class="location-title">Đang tải...</h1>
                            <p id="current-time-date" class="location-subtitle">...</p>
                        </div>
                        <div id="loading-spinner" class="spinner hidden"></div>
                    </div>
                    <div class="current-weather-display">
                        <div id="current-weather-icon-container" class="weather-icon-lg"></div>
                        <div>
                            <div id="current-temp" class="temp-display">--°</div>
                            <div id="current-condition" class="condition-display">...</div>
                        </div>
                    </div>
                    <div class="grid-stats">
                        <div class="glass-item stat-card"><span class="material-symbols-rounded text-blue">air</span><div><div class="stat-label">Gió</div><div id="current-wind" class="stat-value">--</div></div></div>
                        <div class="glass-item stat-card"><span class="material-symbols-rounded text-blue">compress</span><div><div class="stat-label">Áp suất</div><div id="current-pressure" class="stat-value">--</div></div></div>
                        <div class="glass-item stat-card"><span class="material-symbols-rounded text-blue">water_drop</span><div><div class="stat-label">Độ ẩm</div><div id="current-humidity" class="stat-value">--</div></div></div>
                        <div class="glass-item stat-card"><span class="material-symbols-rounded text-blue">visibility</span><div><div class="stat-label">Tầm nhìn</div><div id="current-visibility" class="stat-value">--</div></div></div>
                        <div class="glass-item stat-card"><span class="material-symbols-rounded text-blue">dew_point</span><div><div class="stat-label">Điểm sương</div><div id="current-dewpoint" class="stat-value">--</div></div></div>
                        <div class="glass-item stat-card"><span class="material-symbols-rounded text-orange">wb_sunny</span><div><div class="stat-label">UV</div><div id="current-uv" class="stat-value">--</div></div></div>
                    </div>
                </section>
                
                <section id="hourly-forecast-section" class="glass-panel animate-slide-up delay-200">
                    <h2 class="section-title"><span class="material-symbols-rounded">schedule</span> Dự báo hàng giờ</h2>
                    <div id="hourly-forecast-container" class="scroll-container"></div>
                </section>
            </div>
            
            <div class="col-right">
                <section id="daily-forecast-section" class="glass-panel daily-forecast-section animate-slide-up delay-300">
                    <h2 class="section-title"><span class="material-symbols-rounded">calendar_month</span> Dự báo 14 ngày</h2>
                    <div id="daily-forecast-container" class="daily-list custom-scrollbar"></div>
                </section>
                
                <section id="weather-map-section" class="glass-panel map-section animate-slide-up delay-400">
                    <div class="map-header">
                        <h2 class="section-title"><span class="material-symbols-rounded">map</span> Bản đồ</h2>
                        <button id="map-details-button" class="btn-link">Mở rộng <span class="material-symbols-rounded" style="font-size: 1.2rem;">open_in_full</span></button>
                    </div>
                    <iframe id="weather-map" class="map-frame" src="about:blank"></iframe>
                </section>
            </div>
            
            <section id="weather-details-section" class="glass-panel animate-slide-up delay-500" style="grid-column: 1 / -1;">
                <h2 class="section-title"><span class="material-symbols-rounded">tune</span> Chỉ số chi tiết</h2>
                <div class="details-grid">
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-blue">thermostat</span><span class="stat-label">Nhiệt độ</span></div><div id="detail-temp" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-blue">device_thermostat</span><span class="stat-label">Cảm giác</span></div><div id="detail-feels-like" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-blue">cloud</span><span class="stat-label">Mây phủ</span></div><div id="detail-cloud-cover" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-blue">rainy</span><span class="stat-label">Lượng mưa</span></div><div id="detail-precipitation" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-blue">air</span><span class="stat-label">Tốc độ gió</span></div><div id="detail-wind" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-blue">water_drop</span><span class="stat-label">Độ ẩm</span></div><div id="detail-humidity" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-orange">wb_sunny</span><span class="stat-label">Chỉ số UV</span></div><div id="detail-uv" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-green">aq_indoor</span><span class="stat-label">AQI (KK)</span></div><div id="detail-aqi" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-blue">visibility</span><span class="stat-label">Tầm nhìn</span></div><div id="detail-visibility" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-blue">compress</span><span class="stat-label">Áp suất</span></div><div id="detail-pressure" class="detail-box-value">--</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-yellow">light_mode</span><span class="stat-label">Mặt trời</span></div><div id="detail-sun" class="detail-box-value" style="font-size: 1.1rem;">-- / --</div></div>
                    <div class="glass-item detail-box"><div class="detail-box-header"><span class="material-symbols-rounded text-purple">dark_mode</span><span class="stat-label">Mặt trăng</span></div><div id="detail-moon" class="detail-box-value" style="font-size: 1.1rem;">N/A</div></div>
                </div>
            </section>
        </main>
        
        <div id="error-message" class="toast hidden"><span class="material-symbols-rounded" style="margin-right: 0.5rem;">warning</span><span id="error-text">Lỗi</span></div>
        <div id="map-modal" class="modal-overlay hidden">
            <header class="modal-header">
                <h2 class="font-bold" style="font-size: 1.5rem;">Bản đồ chi tiết</h2>
                <button id="map-close-button" class="btn-circle"><span class="material-symbols-rounded">close</span></button>
            </header>
            <main class="modal-content"><iframe id="full-weather-map" class="full-map" src="about:blank" frameborder="0"></iframe></main>
        </div>

        <div id="settings-menu-container" class="settings-overlay hidden">
            <div id="settings-menu" class="settings-menu">
                <div id="settings-main-menu">
                    <h3 class="font-bold mb-4" style="font-size: 1.125rem; padding: 0 0.5rem;">Cài đặt</h3>
                    <button id="install-app-button" class="menu-btn hidden" style="margin-bottom: 0.25rem;">
                        <div class="menu-btn-content">
                            <span class="material-symbols-rounded" style="color:var(--accent-blue);">download</span>
                            <span style="font-weight: 500;">Cài đặt ứng dụng</span>
                        </div>
                        <span class="material-symbols-rounded" style="color:#94a3b8;">chevron_right</span>
                    </button>
                    <button id="theme-menu-button" class="menu-btn"><div class="menu-btn-content"><span class="material-symbols-rounded" style="color:#64748b;">palette</span><span>Giao diện</span></div><span class="material-symbols-rounded" style="color:#94a3b8;">chevron_right</span></button>
                </div>
                <div id="settings-theme-menu" class="hidden">
                    <div style="display: flex; items-center; margin-bottom: 1rem;">
                        <button id="theme-back-button" class="btn-circle" style="width: 36px; height: 36px; margin-right: 0.5rem;"><span class="material-symbols-rounded">arrow_back</span></button>
                        <h3 class="font-bold" style="font-size: 1.125rem;">Giao diện</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <button data-theme="light" class="theme-option menu-btn"><div class="menu-btn-content"><span class="material-symbols-rounded">light_mode</span> Sáng</div></button>
                        <button data-theme="dark" class="theme-option menu-btn"><div class="menu-btn-content"><span class="material-symbols-rounded">dark_mode</span> Tối</div></button>
                        <button data-theme="system" class="theme-option menu-btn"><div class="menu-btn-content"><span class="material-symbols-rounded">settings_system_daydream</span> Hệ thống</div></button>
                        <button data-theme="clock" class="theme-option menu-btn"><div class="menu-btn-content"><span class="material-symbols-rounded">schedule</span> Theo giờ</div></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GITHUB_BASE_URL = "https://raw.githubusercontent.com/nnam0308/weather/dfbb5f8d2777fdc675d333464f417a4b75c2a3b3/v4/";
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const searchSuggestions = document.getElementById('search-suggestions');
            const searchLoading = document.getElementById('search-loading');
            const headerClock = document.getElementById('header-clock');
            const headerDate = document.getElementById('header-date');
            const currentLocationEl = document.getElementById('current-location');
            const currentTimeDateEl = document.getElementById('current-time-date');
            const currentTempEl = document.getElementById('current-temp');
            const currentConditionEl = document.getElementById('current-condition');
            const currentWeatherIconContainer = document.getElementById('current-weather-icon-container');
            const hourlyForecastContainer = document.getElementById('hourly-forecast-container');
            const dailyForecastContainer = document.getElementById('daily-forecast-container');
            const weatherMapEl = document.getElementById('weather-map');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessageEl = document.getElementById('error-message');
            const errorTextEl = document.getElementById('error-text');
            const mapModal = document.getElementById('map-modal');
            const mapDetailsButton = document.getElementById('map-details-button');
            const mapCloseButton = document.getElementById('map-close-button');
            const fullWeatherMap = document.getElementById('full-weather-map');
            const detectLocationButton = document.getElementById('detect-location-button');
            const settingsButton = document.getElementById('settings-button');
            const weatherEffectsContainer = document.getElementById('weather-effects-container');

            let currentCity = "Nha Trang";
            let currentLat = 12.2388;
            let currentLon = 109.1967;
            let searchTimeout;
            let currentTheme = localStorage.getItem('theme') || 'system';
            let globalWeatherData = null;
            let selectedDayIndex = 0;
            let currentEffectInterval = null;

            let deferredPrompt;
            const installBtn = document.getElementById('install-app-button');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden');
            });
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return; deferredPrompt.prompt();
                await deferredPrompt.userChoice; deferredPrompt = null; installBtn.classList.add('hidden');
            });
            window.addEventListener('appinstalled', () => { installBtn.classList.add('hidden'); deferredPrompt = null; });

            // NEW: Function to update Window Title Bar Color (PWA) & Tile Color
            function updateAppThemeColor(className) {
                const metaThemeColor = document.getElementById('meta-theme-color');
                const metaTileColor = document.getElementById('meta-tile-color');
                let color = '#f9fafb'; // Default light mode top color

                // Define colors based on gradient tops from CSS
                if (className.includes('weather-default')) {
                    if (document.documentElement.classList.contains('dark')) color = '#0f172a'; // Dark mode top
                    else color = '#f9fafb';
                } else if (className.includes('weather-sun-light')) {
                    color = '#FFF9C4';
                } else if (className.includes('weather-sun-intense')) {
                    color = '#FFB300';
                } else if (className.includes('weather-cloudy-grey')) {
                    color = '#78909C';
                } else if (className.includes('weather-rain-day')) {
                    color = '#42A5F5';
                } else if (className.includes('weather-rain-night')) {
                    color = '#1A237E';
                } else if (className.includes('weather-night-clear')) {
                    color = '#0D47A1';
                }
                
                // Update theme-color (Chrome/Edge/Android/macOS PWA)
                metaThemeColor.setAttribute('content', color);
                // Update msapplication-TileColor (Windows Start)
                metaTileColor.setAttribute('content', color);
            }

            function renderWeatherEffects(weatherCode, isDay) {
                if (currentEffectInterval) { clearInterval(currentEffectInterval); currentEffectInterval = null; }
                weatherEffectsContainer.innerHTML = '';
                
                const isRainy = (weatherCode >= 51 && weatherCode <= 67) || (weatherCode >= 80 && weatherCode <= 82) || weatherCode >= 95;
                const isThunder = weatherCode >= 95;
                const isClear = weatherCode <= 1;

                if (isRainy) {
                    const rainCount = 100; 
                    for (let i = 0; i < rainCount; i++) {
                        const drop = document.createElement('div');
                        drop.classList.add('rain-drop');
                        drop.style.left = Math.random() * 100 + 'vw';
                        drop.style.animationDuration = Math.random() * 1 + 0.5 + 's';
                        drop.style.animationDelay = Math.random() * 2 + 's';
                        weatherEffectsContainer.appendChild(drop);
                    }
                }

                if (isThunder) {
                    const thunder = document.createElement('div');
                    thunder.classList.add('thunder-flash');
                    weatherEffectsContainer.appendChild(thunder);
                    
                    const boltContainer = document.createElement('div');
                    boltContainer.style.position = 'absolute'; boltContainer.style.top = '0'; boltContainer.style.left = '0';
                    boltContainer.style.width = '100%'; boltContainer.style.height = '60%'; boltContainer.style.pointerEvents = 'none';
                    weatherEffectsContainer.appendChild(boltContainer);

                    const triggerThunder = () => {
                        thunder.style.animation = 'none'; thunder.offsetHeight; thunder.style.animation = 'flash 0.4s ease-out';
                        const bolt = document.createElement('div');
                        bolt.classList.add('lightning-bolt');
                        bolt.style.left = Math.random() * 90 + '%'; bolt.style.top = Math.random() * 20 + '%';
                        bolt.style.animation = 'strike 0.7s ease-out forwards';
                        boltContainer.appendChild(bolt);
                        setTimeout(() => { if(bolt.parentNode) bolt.remove(); }, 800);
                    };

                    currentEffectInterval = setInterval(() => { if(Math.random() > 0.5) triggerThunder(); }, 3500);
                }

                if (isClear && isDay) {
                     if (weatherCode === 0) { 
                         const glare = document.createElement('div'); glare.classList.add('sun-glare');
                         weatherEffectsContainer.appendChild(glare);
                         const core = document.createElement('div'); core.classList.add('sun-core');
                         weatherEffectsContainer.appendChild(core);
                         for (let i = 0; i < 15; i++) {
                            const drop = document.createElement('div');
                            drop.classList.add('sweat-drop');
                            drop.style.left = Math.random() * 100 + 'vw';
                            drop.style.top = Math.random() * 50 + 'vh';
                            drop.style.animationDuration = Math.random() * 3 + 2 + 's';
                            drop.style.animationDelay = Math.random() * 5 + 's';
                            weatherEffectsContainer.appendChild(drop);
                         }
                     } else {
                         const beam = document.createElement('div'); beam.classList.add('sun-beam');
                         weatherEffectsContainer.appendChild(beam);
                     }
                }
            }

            function animateCountUp(el, targetValue, unit = '', duration = 1000) {
                const target = Math.round(targetValue);
                if (isNaN(target)) { el.textContent = typeof targetValue === 'string' ? targetValue : `${targetValue}${unit}`; return; }
                let startValue = parseInt(el.textContent) || 0;
                if (isNaN(startValue)) startValue = 0;
                if (startValue === target) { el.textContent = `${target}${unit}`; return; }
                let startTime = null;
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    const currentValue = Math.floor(progress * (target - startValue) + startValue);
                    el.textContent = `${currentValue}${unit}`;
                    if (progress < 1) window.requestAnimationFrame(step); else el.textContent = `${target}${unit}`;
                };
                window.requestAnimationFrame(step);
            }

            function applyTheme(theme) {
                const hour = new Date().getHours();
                const isDark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) || (theme === 'clock' && (hour >= 18 || hour < 6));
                if (isDark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
                
                // Re-apply theme color when toggling dark mode manually
                if(globalWeatherData) updateAppThemeColor(document.body.className);
            }

            function updateClock() {
                const now = new Date();
                headerClock.textContent = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                headerDate.textContent = now.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' });
                if (globalWeatherData && selectedDayIndex === 0 && currentTimeDateEl) {
                     currentTimeDateEl.textContent = `${headerClock.textContent} - ${headerDate.textContent}`;
                }
                if (currentTheme === 'clock') applyTheme('clock');
            }

            function showError(msg) {
                errorTextEl.textContent = msg; errorMessageEl.classList.remove('hidden');
                setTimeout(() => errorMessageEl.classList.add('hidden'), 4000);
            }

            function getWeatherIcon(code, hour) {
                const isNight = (hour >= 18 || hour < 6);
                const icons = {
                    0: isNight ? 'clear_night.svg' : 'clear_day.svg',
                    1: isNight ? 'mostly_clear_night.svg' : 'mostly_clear_day.svg',
                    2: isNight ? 'partly_cloudy_night.svg' : 'partly_cloudy_day.svg',
                    3: 'cloudy.svg', 45: 'haze_fog_dust_smoke.svg', 48: 'haze_fog_dust_smoke.svg',
                    51: 'drizzle.svg', 53: 'drizzle.svg', 55: 'drizzle.svg',
                    61: isNight ? 'rain_with_cloudy_dark.svg' : 'rain_with_cloudy_light.svg',
                    63: 'showers_rain.svg', 65: 'heavy_rain.svg',
                    71: isNight ? 'snow_with_cloudy_dark.svg' : 'snow_with_cloudy_light.svg',
                    73: 'showers_snow.svg', 75: 'heavy_snow.svg',
                    80: isNight ? 'scattered_showers_night.svg' : 'scattered_showers_day.svg',
                    81: 'showers_rain.svg', 82: 'heavy_rain.svg',
                    95: isNight ? 'isolated_scattered_thunderstorms_night.svg' : 'isolated_scattered_thunderstorms_day.svg',
                };
                return GITHUB_BASE_URL + (icons[code] || 'cloudy.svg');
            }

            function getWeatherDescription(code) {
                const desc = {
                    0:'Trời quang',1:'Ít mây',2:'Mây rải rác',3:'Nhiều mây',
                    45:'Sương mù',48:'Sương muối',51:'Mưa phùn nhẹ',53:'Mưa phùn',55:'Mưa phùn dày',
                    61:'Mưa nhỏ',63:'Mưa vừa',65:'Mưa to',71:'Tuyết rơi nhẹ',73:'Tuyết rơi',75:'Tuyết rơi dày',
                    80:'Mưa rào nhẹ',81:'Mưa rào',82:'Mưa rất to',95:'Dông',96:'Dông mưa đá',99:'Dông nặng'
                };
                return desc[code] || 'Không xác định';
            }

            function getWeatherBackgroundClass(code) {
                const hour = new Date().getHours();
                const isNight = (hour >= 18 || hour < 6);
                if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) return isNight ? 'weather-rain-night' : 'weather-rain-day';
                if (code >= 95) return 'weather-cloudy-grey';
                if (code <= 1) {
                    if (isNight) return 'weather-night-clear';
                    if ((hour >= 6 && hour < 9) || (hour >= 16 && hour < 18)) return 'weather-sun-light';
                    return 'weather-sun-intense';
                }
                return 'weather-cloudy-grey';
            }

            async function fetchLocationName(lat, lon) {
                try {
                    const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=vi`);
                    if(!res.ok) throw new Error();
                    const data = await res.json();
                    let name = '';
                    if (data.localityInfo?.administrative) {
                        const admin = data.localityInfo.administrative.sort((a, b) => b.adminLevel - a.adminLevel);
                        const local = admin.find(i => i.adminLevel >= 8) || admin[0];
                        const district = admin.find(i => i.adminLevel === 6);
                        const prov = admin.find(i => i.adminLevel === 4);
                        const parts = [local?.name, district?.name !== local?.name ? district?.name : null, prov?.name !== district?.name ? prov?.name : null].filter(Boolean);
                        name = parts.length > 2 ? `${parts[0]}, ${parts[1]}` : parts.join(', ');
                    } else {
                        name = [data.locality, data.city, data.principalSubdivision].filter(Boolean).join(', ');
                    }
                    currentCity = name || "Vị trí không xác định";
                    currentLat = lat; currentLon = lon;
                    fetchWeather(lat, lon, currentCity);
                    fetchAQI(lat, lon);
                } catch(e) { 
                    console.error(e);
                    showError('Không thể lấy tên địa điểm.');
                    loadingSpinner.classList.add('hidden');
                }
            }

            async function fetchAQI(lat, lon) {
                try {
                    const res = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi`);
                    const data = await res.json();
                    document.getElementById('detail-aqi').textContent = data.current?.us_aqi || '--';
                } catch(e) { console.error(e); }
            }

            async function fetchWeather(lat, lon, city) {
                loadingSpinner.classList.remove('hidden');
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relativehumidity_2m,weathercode,windspeed_10m,pressure_msl,dewpoint_2m,visibility,uv_index,apparent_temperature,cloudcover,precipitation&hourly=temperature_2m,weathercode,temperature_80m,precipitation_probability,relativehumidity_2m,surface_pressure,visibility,windspeed_10m&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max,precipitation_sum,wind_speed_10m_max&timezone=auto&forecast_days=14`);
                    if(!res.ok) throw new Error('Lỗi tải thời tiết');
                    const data = await res.json();
                    
                    globalWeatherData = data; selectedDayIndex = 0; updateUI(data, city);
                    weatherMapEl.src = `https://embed.windy.com/embed.html?type=map&location=coordinates&metricWind=kmh&metricTemp=°C&radarRange=-1&lat=${lat}&lon=${lon}&zoom=9`;
                    
                } catch(e) {
                    showError(e.message);
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }

            function updateUI(data, city) {
                currentLocationEl.textContent = city;
                renderDailyList(data);
                updateDashboard(selectedDayIndex);
            }

            window.selectDay = function(index) {
                if (index === selectedDayIndex) return;
                selectedDayIndex = index;
                document.querySelectorAll('.daily-card').forEach((card, idx) => {
                    if (idx === index) card.classList.add('active'); else card.classList.remove('active');
                });
                loadingSpinner.classList.remove('hidden');
                setTimeout(() => { updateDashboard(index); loadingSpinner.classList.add('hidden'); }, 200);
            };

            function updateDashboard(index) {
                const data = globalWeatherData;
                if (!data) return;
                const isToday = index === 0;
                const daily = data.daily;
                const hourly = data.hourly;
                const current = data.current;
                const dateStr = daily.time[index];
                const dateObj = new Date(dateStr);
                const fullDateText = dateObj.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' });
                currentTimeDateEl.textContent = isToday ? `${headerClock.textContent} - ${fullDateText}` : fullDateText;

                let displayTemp, displayCode, displayDesc, displayWind, displayPressure, displayHumidity, displayVis, displayDew, displayUV;
                let isDayTime = true; 

                if (isToday) {
                    const h = new Date().getHours();
                    isDayTime = h >= 6 && h < 18;
                    displayTemp = current.temperature_2m;
                    displayCode = current.weathercode;
                    displayDesc = getWeatherDescription(displayCode);
                    displayWind = current.windspeed_10m;
                    displayPressure = current.pressure_msl;
                    displayHumidity = current.relativehumidity_2m;
                    displayVis = current.visibility/1000;
                    displayDew = current.dewpoint_2m;
                    displayUV = Math.round(current.uv_index);
                } else {
                    isDayTime = true; 
                    displayTemp = Math.round(daily.temperature_2m_max[index]);
                    displayCode = daily.weathercode[index];
                    displayDesc = getWeatherDescription(displayCode);
                    displayWind = daily.wind_speed_10m_max[index];
                    displayUV = daily.uv_index_max[index];
                    const dayStartIndex = index * 24;
                    const dayEndIndex = dayStartIndex + 24;
                    const getAvg = (arr) => {
                        const slice = arr.slice(dayStartIndex, dayEndIndex);
                        const sum = slice.reduce((a, b) => a + b, 0);
                        return slice.length ? Math.round(sum / slice.length) : '--';
                    };
                    displayHumidity = getAvg(hourly.relativehumidity_2m);
                    displayPressure = getAvg(hourly.surface_pressure);
                    displayVis = (getAvg(hourly.visibility) / 1000).toFixed(1);
                    displayDew = "--"; 
                }

                animateCountUp(currentTempEl, displayTemp, '°');
                currentConditionEl.textContent = displayDesc;
                currentWeatherIconContainer.innerHTML = `<img src="${getWeatherIcon(displayCode, isDayTime ? 12 : 0)}" class="weather-icon loaded animate-slide-up">`;
                
                const stats = {
                    'current-wind': [displayWind, ' km/h'],
                    'current-pressure': [displayPressure, ' hPa'],
                    'current-humidity': [displayHumidity, '%'],
                    'current-visibility': [displayVis, ' km'],
                    'current-dewpoint': [displayDew, '°'],
                    'current-uv': [displayUV, '']
                };
                for(const [id, [val, unit]] of Object.entries(stats)) {
                    const el = document.getElementById(id); if(el) animateCountUp(el, val, unit);
                }

                const detailMap = {
                    'detail-temp': [isToday ? current.temperature_2m : daily.temperature_2m_max[index], '°C'],
                    'detail-feels-like': [isToday ? current.apparent_temperature : '--', '°C'],
                    'detail-cloud-cover': ['--', '%'],
                    'detail-precipitation': [daily.precipitation_sum[index], ' mm'],
                    'detail-wind': [displayWind, ' km/h'],
                    'detail-humidity': [displayHumidity, '%'],
                    'detail-uv': [displayUV, ''],
                    'detail-visibility': [displayVis, ' km'],
                    'detail-pressure': [displayPressure, ' hPa'],
                };
                for(const [id, [val, unit]] of Object.entries(detailMap)) {
                    const el = document.getElementById(id); if(el) animateCountUp(el, val, unit);
                }
                
                const sunrise = new Date(daily.sunrise[index]).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
                const sunset = new Date(daily.sunset[index]).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
                document.getElementById('detail-sun').textContent = `${sunrise} / ${sunset}`;

                const newClass = `${getWeatherBackgroundClass(displayCode)}`;
                document.body.className = newClass;
                // NEW: Update theme color when background changes
                updateAppThemeColor(newClass);

                const realHour = new Date().getHours();
                const effectIsDay = isToday ? (realHour >= 6 && realHour < 18) : true;
                renderWeatherEffects(displayCode, effectIsDay);

                hourlyForecastContainer.innerHTML = '';
                let startH = 0; let endH = 0;

                if (isToday) {
                    const currentHour = new Date().getHours();
                    const todayDate = daily.time[0]; 
                    startH = hourly.time.findIndex(t => t.startsWith(todayDate) && new Date(t).getHours() === currentHour);
                    if (startH === -1) startH = 0; 
                    const tomorrowDate = daily.time[1];
                    endH = hourly.time.findIndex(t => t.startsWith(tomorrowDate));
                    if (endH === -1) endH = hourly.time.length; 
                } else {
                    const targetDate = daily.time[index];
                    startH = hourly.time.findIndex(t => t.startsWith(targetDate));
                    endH = startH + 24;
                }

                if (startH !== -1 && endH > startH) {
                    for(let i=startH; i<endH && i<hourly.time.length; i++) {
                        const time = new Date(hourly.time[i]);
                        const hCode = hourly.weathercode[i];
                        const hTemp = Math.round(hourly.temperature_2m[i]);
                        const hProb = hourly.precipitation_probability[i];
                        
                        const hHtml = `
                            <div class="glass-item hourly-card">
                                <div class="font-bold mb-1" style="font-size: 0.875rem;">${time.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'})}</div>
                                <div style="width: 2.5rem; height: 2.5rem; margin: 0.25rem 0;"><img src="${getWeatherIcon(hCode, time.getHours())}" class="w-full h-full"></div>
                                <div class="font-bold" style="font-size: 1.125rem;">${hTemp}°</div>
                                <div class="opacity-80 leading-tight mb-1" style="font-size: 0.75rem;">${getWeatherDescription(hCode)}</div>
                                <div class="opacity-60" style="font-size: 0.75rem;">${hProb}% mưa</div>
                            </div>`;
                        hourlyForecastContainer.insertAdjacentHTML('beforeend', hHtml);
                    }
                } else {
                     hourlyForecastContainer.innerHTML = '<div style="padding:1rem; opacity:0.7;">Không có dữ liệu dự báo cho khung giờ này.</div>';
                }

                if (weatherMapEl.src && !weatherMapEl.src.includes('about:blank')) {
                    let url = new URL(weatherMapEl.src);
                }
            }

            function renderDailyList(data) {
                dailyForecastContainer.innerHTML = '';
                for(let i=0; i<data.daily.time.length; i++) {
                    const date = new Date(data.daily.time[i]);
                    const dCode = data.daily.weathercode[i];
                    const max = Math.round(data.daily.temperature_2m_max[i]);
                    const min = Math.round(data.daily.temperature_2m_min[i]);
                    const isActive = i === selectedDayIndex ? 'active' : '';
                    
                    const dHtml = `
                        <div class="glass-item daily-card ${isActive}" onclick="selectDay(${i})">
                            <div class="text-center" style="width: 3.5rem;">
                                <div class="font-bold">${date.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit'})}</div>
                                <div class="opacity-70" style="font-size: 0.75rem;">${date.toLocaleDateString('vi-VN',{weekday:'short'})}</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                <div style="width: 2.5rem; height: 2.5rem; margin-bottom: 0.25rem;"><img src="${getWeatherIcon(dCode, 12)}" class="w-full h-full"></div>
                                <div style="font-size: 0.75rem; text-align: center; font-weight: 500;">${getWeatherDescription(dCode)}</div>
                            </div>
                            <div class="text-right" style="width: 3rem;">
                                <div class="font-bold">${max}°</div>
                                <div class="opacity-70" style="font-size: 0.75rem;">${min}°</div>
                            </div>
                        </div>`;
                    dailyForecastContainer.insertAdjacentHTML('beforeend', dHtml);
                }
            }

            searchForm.addEventListener('submit', (e) => {
                e.preventDefault(); const q = searchInput.value.trim();
                if(q) { clearTimeout(searchTimeout); fetchSuggestions(q); }
            });
            
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout); const q = searchInput.value.trim();
                if(q.length >= 1) searchTimeout = setTimeout(() => fetchSuggestions(q), 400);
                else { searchSuggestions.classList.add('hidden'); searchLoading.classList.add('hidden'); }
            });

            async function fetchSuggestions(q) {
                searchLoading.classList.remove('hidden'); 
                try {
                    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=10&language=vi&format=json`);
                    const data = await res.json();
                    searchSuggestions.innerHTML = ''; 
                    if(!data.results || data.results.length === 0) {
                        const div = document.createElement('div');
                        div.className = "suggestion-item"; div.style.textAlign = "center"; div.style.opacity = "0.7";
                        div.textContent = "Không tìm thấy địa điểm"; searchSuggestions.appendChild(div); searchSuggestions.classList.remove('hidden'); return;
                    }
                    const unique = []; const seen = new Set();
                    data.results.forEach(i => { const k = `${i.name}-${i.admin1}-${i.country}`; if(!seen.has(k)) { seen.add(k); unique.push(i); } });
                    unique.slice(0,8).forEach(loc => {
                        const div = document.createElement('div'); div.className = "suggestion-item";
                        const subText = [loc.admin1, loc.country].filter(Boolean).join(', ');
                        div.innerHTML = `<div class="font-bold">${loc.name}</div><div class="opacity-70" style="font-size: 0.75rem;">${subText}</div>`;
                        div.onclick = () => {
                            currentCity = `${loc.name}, ${loc.admin1 || loc.country}`;
                            currentLat = loc.latitude; currentLon = loc.longitude;
                            fetchWeather(currentLat, currentLon, currentCity); fetchAQI(currentLat, currentLon);
                            searchSuggestions.classList.add('hidden'); searchInput.value = ''; 
                        };
                        searchSuggestions.appendChild(div);
                    });
                    searchSuggestions.classList.remove('hidden');
                } catch(e) { console.error(e); searchSuggestions.classList.add('hidden'); }
                finally { searchLoading.classList.add('hidden'); }
            }

            detectLocationButton.onclick = () => {
                if('geolocation' in navigator) {
                    loadingSpinner.classList.remove('hidden');
                    navigator.geolocation.getCurrentPosition(
                        pos => fetchLocationName(pos.coords.latitude, pos.coords.longitude),
                        () => { showError('Lỗi định vị.'); loadingSpinner.classList.add('hidden'); }
                    );
                }
            };

            document.getElementById('settings-menu-container').onclick = (e) => {
                if(e.target === document.getElementById('settings-menu-container')) {
                    document.getElementById('settings-menu-container').classList.add('hidden');
                    document.getElementById('settings-main-menu').classList.remove('hidden');
                    document.getElementById('settings-theme-menu').classList.add('hidden');
                }
            };
            settingsButton.onclick = () => document.getElementById('settings-menu-container').classList.remove('hidden');
            document.getElementById('theme-menu-button').onclick = () => {
                document.getElementById('settings-main-menu').classList.add('hidden');
                document.getElementById('settings-theme-menu').classList.remove('hidden');
            };
            document.getElementById('theme-back-button').onclick = () => {
                document.getElementById('settings-main-menu').classList.remove('hidden');
                document.getElementById('settings-theme-menu').classList.add('hidden');
            };
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.onclick = () => {
                    currentTheme = btn.dataset.theme;
                    localStorage.setItem('theme', currentTheme);
                    applyTheme(currentTheme);
                    document.getElementById('settings-menu-container').classList.add('hidden');
                }
            });

            mapDetailsButton.onclick = () => {
                fullWeatherMap.src = weatherMapEl.src.replace('zoom=9', 'zoom=5') + '&detail=true&pressure=true';
                mapModal.classList.remove('hidden'); mapModal.classList.remove('modal-exiting'); mapModal.classList.add('modal-entering');
            };
            mapCloseButton.onclick = () => {
                mapModal.classList.remove('modal-entering'); mapModal.classList.add('modal-exiting');
                setTimeout(() => { mapModal.classList.add('hidden'); fullWeatherMap.src = 'about:blank'; }, 200);
            };
            document.addEventListener('click', (e) => { if(!searchForm.contains(e.target)) searchSuggestions.classList.add('hidden'); });

            applyTheme(currentTheme);
            setInterval(updateClock, 1000);
            updateClock();
            detectLocationButton.click(); 
        });
    </script>
</body>
</html>
