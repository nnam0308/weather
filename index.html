<!DOCTYPE html>
<!-- SỬA: Thêm class="dark" sẽ được quản lý bởi JS -->
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Thời tiết</title>
    
    <!-- SỬA LỖI: Tải Tailwind CSS TRƯỚC khi cấu hình nó -->
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- THÊM: Cấu hình Tailwind cho Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Kích hoạt chế độ tối bằng class 'dark'
        }
    </script>
    
    <!-- Tải Google Fonts (Inter) & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- SỬA: Đổi sang Material Symbols Rounded -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <style>
        /* Áp dụng font Inter làm font chữ mặc định */
        body {
            font-family: 'Inter', sans-serif;
            /* THÊM: transition cho background */
            transition: background 0.5s ease-in-out;
        }

        /* Tùy chỉnh thanh cuộn cho phần dự báo */
        .hourly-forecast::-webkit-scrollbar {
            height: 8px; /* Cho thanh ngang */
            width: 8px;  /* Cho thanh dọc */
        }
        .hourly-forecast::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }
        .hourly-forecast::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .hourly-forecast::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }

        /* THÊM: Tùy chỉnh thanh cuộn cho chế độ TỐI */
        html.dark .hourly-forecast::-webkit-scrollbar-track {
            background: #334155; /* slate-700 */
        }
        html.dark .hourly-forecast::-webkit-scrollbar-thumb {
            background: #64748b; /* slate-500 */
        }
        html.dark .hourly-forecast::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }

        /* Lớp tiện ích cho biểu tượng material */
        .icon {
            /* SỬA: Đổi font-family */
            font-family: 'Material Symbols Rounded';
            font-weight: normal;
            font-style: normal;
            font-size: 24px; /* Kích thước mặc định */
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: 'liga';
            
            /* THÊM: Tùy chỉnh cho Material Symbols */
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24;
        }

        /* THÊM: CSS cho các lớp nền (gradient) */
        .weather-default {
            background: linear-gradient(to top, #d2d6db, #f9fafb); /* Default */
        }
        html.dark .weather-default {
            background: linear-gradient(to top, #334155, #0f172a); /* Default Dark */
        }

        /* BAN NGÀY (DAY) 10:00 - 16:59 */
        .weather-day-sunny { background: linear-gradient(to bottom, #87CEEB, #f0f8ff); }
        .weather-day-cloudy { background: linear-gradient(to bottom, #B0C4DE, #f0f8ff); }
        .weather-day-rainy, .weather-day-snowy, .weather-day-foggy {
            background: linear-gradient(to bottom, #778899, #d3d9e0);
        }
        /* BUỔI SÁNG (MORNING) 05:00 - 09:59 */
        .weather-morning-sunny { background: linear-gradient(to bottom, #FFDAB9, #E6E6FA); }
        .weather-morning-cloudy { background: linear-gradient(to bottom, #D8BFD8, #E6E6FA); }
        .weather-morning-rainy, .weather-morning-snowy, .weather-morning-foggy {
            background: linear-gradient(to bottom, #B0C4DE, #E0E0E0);
        }
        /* BUỔI TỐI (EVENING) 17:00 - 19:59 */
        .weather-evening-sunny { background: linear-gradient(to bottom, #FF7F50, #4682B4); }
        .weather-evening-cloudy { background: linear-gradient(to bottom, #6A5ACD, #4682B4); }
        .weather-evening-rainy, .weather-evening-snowy, .weather-evening-foggy {
            background: linear-gradient(to bottom, #483D8B, #606f86);
        }
        /* BAN ĐÊM (NIGHT) 20:00 - 04:59 */
        .weather-night-clear { background: linear-gradient(to bottom, #000080, #191970); }
        .weather-night-cloudy { background: linear-gradient(to bottom, #2F4F4F, #1E1E1E); }
        .weather-night-rainy, .weather-night-snowy, .weather-night-foggy {
            background: linear-gradient(to bottom, #303030, #101010);
        }

        /* THÊM: Animation khi tải trang */
        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .load-animate {
            opacity: 0; /* Bắt đầu ẩn */
            animation: slideUpFadeIn 0.5s ease-out forwards;
        }
        /* THÊM: Animation-delay cho các mục */
        #current-info-section { animation-delay: 0.1s; }
        #hourly-forecast-section { animation-delay: 0.2s; }
        #daily-forecast-section { animation-delay: 0.3s; }
        #weather-map-section { animation-delay: 0.4s; }

        /* THÊM: Animation cho Modal (thay thế 'hidden') */
        #map-modal {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s;
            opacity: 0;
            transform: scale(0.95);
            visibility: hidden; /* Ẩn đi nhưng vẫn cho phép transition */
            display: flex; /* Luôn là flex để căn giữa */
        }
        #map-modal.modal-open {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
        }

    </style>
</head>
<!-- SỬA: Bỏ bg-slate-100, thêm class weather-default làm mặc định -->
<body class="text-slate-800 dark:text-slate-200 p-4 md:p-8 min-h-screen weather-default">

    <div class="max-w-screen-2xl mx-auto">
        
        <!-- HEADER -->
        <header class="grid grid-cols-3 items-center gap-4 mb-6">
            <!-- Trái: Clock & Date -->
            <div classs="col-span-1">
                <!-- SỬA: Thêm lớp text-white -->
                <div id="header-clock" class="text-2xl font-bold text-white">14:30</div>
                <!-- SỬA: Xóa lớp text-slate-*, thêm text-white và một chút opacity -->
                <div id="header-date" class="text-sm text-white opacity-80">Thứ Hai, 17/11/2025</div>
            </div>
            
            <!-- Giữa: Search Box -->
            <div class="col-span-1 flex justify-center">
                <form id="search-form" class="w-full max-w-md">
                    <div class="relative">
                        <span class="icon absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                        <!-- SỬA: Thêm hiệu ứng đàn hồi khi focus -->
                        <input type="text" id="search-input" placeholder="Tìm kiếm vị trí..." class="w-full bg-white dark:bg-slate-700 shadow-sm rounded-full py-3 px-12 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-transform duration-100 ease-out focus:scale-[1.02]"> <!-- SỬA: dark: -->
                        <!-- Thùng chứa gợi ý -->
                        <div id="search-suggestions" class="hidden absolute top-full mt-2 w-full bg-white dark:bg-slate-700 rounded-2xl shadow-lg z-10 overflow-hidden"> <!-- SỬA: dark: -->
                            <!-- Gợi ý sẽ được chèn vào đây -->
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Phải: Settings -->
            <div class="col-span-1 flex justify-end relative"> <!-- SỬA: Thêm relative -->
                <!-- SỬA: Thêm hiệu ứng đàn hồi -->
                <button id="settings-button" class="bg-white dark:bg-slate-700 dark:hover:bg-slate-600 p-3 rounded-full shadow-sm hover:bg-slate-200 transition-colors transition-transform duration-100 ease-out active:scale-95"> <!-- SỬA: Thêm id, dark: -->
                    <span class="icon">settings</span>
                </button>

                <!-- THÊM MỚI: Menu Cài đặt -->
                <div id="settings-menu" class="hidden absolute top-full right-0 mt-2 w-64 bg-white dark:bg-slate-800 rounded-2xl shadow-lg z-20 overflow-hidden border dark:border-slate-700">
                    <!-- Menu chính -->
                    <div id="settings-main-view">
                        <div class="p-4 border-b dark:border-slate-700">
                            <h3 class="font-bold text-lg">Cài đặt</h3>
                        </div>
                        <!-- SỬA: Thêm hiệu ứng đàn hồi -->
                        <button id="theme-menu-button" class="w-full flex justify-between items-center p-4 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors transition-transform duration-100 ease-out active:scale-95">
                            <div class="flex items-center gap-3">
                                <span class="icon">brightness_6</span>
                                <span>Giao diện (Theme)</span>
                            </div>
                            <span id="current-theme-label" class="text-sm text-slate-500 dark:text-slate-400">Hệ thống</span>
                        </button>
                        <!-- Thêm các cài đặt khác ở đây sau này -->
                    </div>
                    
                    <!-- Menu con (Theme) -->
                    <div id="theme-submenu" class="hidden">
                        <!-- SỬA: Thêm hiệu ứng đàn hồi -->
                        <button id="theme-menu-back" class="w-full flex items-center gap-3 p-4 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors transition-transform duration-100 ease-out active:scale-95">
                            <span class="icon text-sm">arrow_back_ios</span>
                            <span>Giao diện</span>
                        </button>
                        <hr class="border-slate-200 dark:border-slate-700">
                        <!-- SỬA: Thêm hiệu ứng đàn hồi -->
                        <button data-theme="light" class="theme-option-button w-full text-left p-4 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors transition-transform duration-100 ease-out active:scale-95 flex justify-between items-center">
                            <span>Sáng</span>
                            <span class="icon text-blue-500 hidden">check</span>
                        </button>
                        <!-- SỬA: Thêm hiệu ứng đàn hồi -->
                        <button data-theme="dark" class="theme-option-button w-full text-left p-4 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors transition-transform duration-100 ease-out active:scale-95 flex justify-between items-center">
                            <span>Tối</span>
                            <span class="icon text-blue-500 hidden">check</span>
                        </button>
                        <!-- SỬA: Thêm hiệu ứng đàn hồi -->
                        <button data-theme="system" class="theme-option-button w-full text-left p-4 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors transition-transform duration-100 ease-out active:scale-95 flex justify-between items-center">
                            <span>Theo hệ thống</span>
                            <span class="icon text-blue-500 hidden">check</span>
                        </button>
                        <!-- SỬA: Thêm hiệu ứng đàn hồi -->
                        <button data-theme="auto" class="theme-option-button w-full text-left p-4 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors transition-transform duration-100 ease-out active:scale-95 flex justify-between items-center">
                            <span>Theo đồng hồ (Tự động)</span>
                            <span class="icon text-blue-500 hidden">check</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- BÊN TRÁI (1/2) -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                
                <!-- Mục Hiện thông tin -->
                <!-- SỬA: Thêm class animation -->
                <section id="current-info-section" class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-lg load-animate"> <!-- SỬA: dark: -->
                    <!-- Dòng 1 & 2 -->
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 id="current-location" class="text-3xl font-bold">Nha Trang, Khánh Hòa</h1>
                            <p id="current-time-date" class="text-slate-600 dark:text-slate-400">14:30 - Thứ Hai, 17/11/2025</p> <!-- SỬA: dark: -->
                        </div>
                        <div id="loading-spinner" class="hidden animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    </div>
                    
                    <!-- Dòng 3 -->
                    <div class="flex items-center gap-4 mb-6">
                        <span id="current-weather-icon" class="icon text-8xl text-blue-500">sunny</span>
                        <div>
                            <div id="current-temp" class="text-7xl font-bold">29°C</div>
                            <div id="current-condition" class="text-xl text-slate-700 dark:text-slate-300">Trời quang</div> <!-- SỬA: dark: -->
                        </div>
                    </div>
                    
                    <!-- Dòng 4: Thông tin chi tiết -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="flex items-center gap-2">
                            <span class="icon text-blue-500">air</span>
                            <div>
                                <div>Gió</div>
                                <div id="current-wind" class="font-bold">12 km/h</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="icon text-blue-500">compress</span>
                            <div>
                                <div>Áp suất</div>
                                <div id="current-pressure" class="font-bold">1012 hPa</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="icon text-blue-500">water_drop</span>
                            <div>
                                <div>Độ ẩm</div>
                                <div id="current-humidity" class="font-bold">75%</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="icon text-blue-500">visibility</span>
                            <div>
                                <div>Tầm nhìn</div>
                                <div id="current-visibility" class="font-bold">10 km</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="icon text-blue-500">ac_unit</span>
                            <div>
                                <div>Điểm sương</div>
                                <div id="current-dewpoint" class="font-bold">22°C</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="icon text-blue-500">wb_sunny</span>
                            <div>
                                <div>Chỉ số UV</div>
                                <div id="current-uv" class="font-bold">Cao (7)</div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Mục Dự báo hàng giờ -->
                <!-- SỬA: Thêm class animation -->
                <section id="hourly-forecast-section" class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-lg load-animate"> <!-- SỬA: dark: -->
                    <h2 class="text-xl font-bold mb-4">Dự báo hàng giờ</h2>
                    <div id="hourly-forecast-container" class="hourly-forecast flex gap-4 overflow-x-auto pb-4">
                        <!-- Dữ liệu hàng giờ sẽ được chèn vào đây bởi JS -->
                        <!-- SỬA: p-12 -> p-4 và w-33 -> w-40 -->
                        <div class="text-center flex-shrink-0 p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl w-40"> <!-- SỬA: dark: -->
                            <span class="icon text-3xl text-blue-500">sunny</span>
                            <div class="my-1">
                                <span class="font-bold">30°</span>
                                <span class="text-slate-600 dark:text-slate-400">28°</span> <!-- SỬA: dark: -->
                            </div>
                            <div class="text-sm text-slate-700 dark:text-slate-300 mb-1 truncate">Quang</div> <!-- SỬA: dark: -->
                            <div class="font-bold">13:00</div>
                        </div>
                        <!-- ... các giờ khác ... -->
                    </div>
                </section>
            </div>
            
            <!-- BÊN PHẢI (1/2) -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                
                <!-- Mục Dự báo hàng ngày -->
                <!-- SỬA: Thêm class animation -->
                <section id="daily-forecast-section" class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-lg lg:h-[360px] lg:flex lg:flex-col load-animate"> <!-- SỬA: dark: -->
                    <h2 class="text-xl font-bold mb-4">Dự báo 14 ngày</h2>
                    <!-- SỬA: Thêm các lớp để cuộn ngang trên di động, cuộn dọc trên desktop + sửa lỗi flexbox -->
                    <div id="daily-forecast-container" class="flex gap-4 overflow-x-auto pb-4 hourly-forecast lg:flex-col lg:overflow-x-hidden lg:overflow-y-auto lg:pb-0 lg:flex-1 lg:min-h-0">
                        <!-- Dữ liệu hàng ngày sẽ được chèn vào đây bởi JS -->
                        <!-- SỬA: Cập nhật HTML mẫu để khớp với JS -->
                        <div class="flex-shrink-0 w-40 p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl lg:w-full"> <!-- SỬA: dark: -->
                            <!-- Bố cục DI ĐỘNG -->
                            <div class="flex flex-col items-center text-center lg:hidden">
                                <span class="icon text-3xl text-blue-500">partly_cloudy_day</span>
                                <div class="my-1">
                                    <span class="font-bold">30°</span>
                                    <span class="text-slate-600 dark:text-slate-400">/ 25°</span> <!-- SỬA: dark: -->
                                </div>
                                <div class="text-sm text-slate-700 dark:text-slate-300 truncate">Nhiều mây</div> <!-- SỬA: dark: -->
                                <div class="font-bold mt-1">17/11</div>
                            </div>
                            <!-- Bố cục DESKTOP -->
                            <div class="hidden lg:block">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="font-bold">17/11</div>
                                    <div class="text-slate-600 dark:text-slate-400">Thứ Hai</div> <!-- SỬA: dark: -->
                                </div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="icon text-3xl text-blue-500">partly_cloudy_day</span>
                                    <div>
                                        <span class="font-bold text-lg">30°</span>
                                        <span class="text-slate-600 dark:text-slate-400">/ 25°</span> <!-- SỬA: dark: -->
                                    </div>
                                </div>
                                <div class="text-sm text-slate-700 dark:text-slate-300">Nhiều mây</div> <!-- SỬA: dark: -->
                            </div>
                        </div>
                        <!-- ... các ngày khác ... -->
                    </div>
                </section>
                
                <!-- Mục Weather Map -->
                <!-- SỬA: Thêm class animation -->
                <section id="weather-map-section" class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-lg lg:h-[360px] load-animate"> <!-- SỬA: dark: -->
                    <!-- SỬA: Thêm flex container để chứa nút "Chi tiết" -->
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Bản đồ thời tiết</h2>
                        <!-- THÊM MỚI: Nút mở Modal -->
                        <!-- SỬA: Thêm hiệu ứng đàn hồi -->
                        <button id="open-map-modal" class="text-sm text-blue-600 font-medium hover:text-blue-800 transition-colors flex items-center transition-transform duration-100 ease-out active:scale-95">
                            Chi tiết
                            <span class="icon align-middle text-base">arrow_forward_ios</span>
                        </button>
                    </div>
                    <!-- Sử dụng iframe từ một dịch vụ bản đồ (ví dụ: Windy) -->
                    <iframe 
                        id="weather-map"
                        class="w-full h-[250px] rounded-2xl border border-slate-200"
                        src="https://embed.windy.com/embed.html?type=map&location=coordinates&metricWind=kmh&metricTemp=°C&radarRange=-1&lat=12.2388&lon=109.1967&zoom=9" 
                        frameborder="0">
                    </iframe>
                </section>
            </div>
            
        </main>
        
        <!-- Thông báo Lỗi -->
        <div id="error-message" class="hidden fixed top-5 right-5 bg-red-500 text-white p-4 rounded-lg shadow-md">
            <span class="icon mr-2">error_outline</span>
            <span id="error-text"></span>
        </div>

        <!-- THÊM MỚI: Modal Bản đồ chi tiết -->
        <!-- SỬA: Bỏ 'hidden', CSS sẽ tự xử lý -->
        <div id="map-modal" class="fixed inset-0 bg-white dark:bg-slate-900 z-50 p-6 md:p-8 flex flex-col"> <!-- SỬA: dark: -->
            <!-- Header Modal -->
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-xl font-bold">Bản đồ thời tiết</h2>
                <!-- SỬA: Thêm hiệu ứng đàn hồi -->
                <button id="close-map-modal" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors transition-transform duration-100 ease-out active:scale-95"> <!-- SỬA: dark: -->
                    <span class="icon">close</span>
                </button>
            </div>
            <!-- Nội dung Modal (Iframe) -->
            <div class="flex-1 w-full h-full">
                <iframe 
                    id="full-weather-map"
                    class="w-full h-full rounded-2xl border border-slate-200"
                    src="" <!-- Để trống, JS sẽ điền vào -->
                    frameborder="0">
                </iframe>
            </div>
        </div>
        
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const searchSuggestionsEl = document.getElementById('search-suggestions'); // THÊM
            
            const headerClock = document.getElementById('header-clock');
            const headerDate = document.getElementById('header-date');
            
            const currentLocationEl = document.getElementById('current-location');
            const currentTimeDateEl = document.getElementById('current-time-date');
            const currentTempEl = document.getElementById('current-temp');
            const currentConditionEl = document.getElementById('current-condition');
            const currentWeatherIconEl = document.getElementById('current-weather-icon');
            
            const currentWindEl = document.getElementById('current-wind');
            const currentPressureEl = document.getElementById('current-pressure');
            const currentHumidityEl = document.getElementById('current-humidity');
            const currentVisibilityEl = document.getElementById('current-visibility');
            const currentDewpointEl = document.getElementById('current-dewpoint');
            const currentUvEl = document.getElementById('current-uv');
            
            const hourlyForecastContainer = document.getElementById('hourly-forecast-container');
            const dailyForecastContainer = document.getElementById('daily-forecast-container');
            const weatherMapEl = document.getElementById('weather-map');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessageEl = document.getElementById('error-message');
            const errorTextEl = document.getElementById('error-text');

            const currentInfoSection = document.getElementById('current-info-section');
            const hourlyForecastSection = document.getElementById('hourly-forecast-section');
            const dailyForecastSection = document.getElementById('daily-forecast-section');
            const weatherMapSection = document.getElementById('weather-map-section');

            // THÊM MỚI: Các biến cho Modal Bản đồ
            const openMapModalBtn = document.getElementById('open-map-modal');
            const closeMapModalBtn = document.getElementById('close-map-modal');
            const mapModal = document.getElementById('map-modal');
            const fullWeatherMapEl = document.getElementById('full-weather-map');

            // THÊM MỚI: Các biến cho Menu Cài đặt
            const settingsButton = document.getElementById('settings-button');
            const settingsMenu = document.getElementById('settings-menu');
            const settingsMainView = document.getElementById('settings-main-view');
            const themeMenuButton = document.getElementById('theme-menu-button');
            const themeSubmenu = document.getElementById('theme-submenu');
            const themeMenuBack = document.getElementById('theme-menu-back');
            const themeOptionButtons = document.querySelectorAll('.theme-option-button');
            const currentThemeLabel = document.getElementById('current-theme-label');


            let currentCity = "Nha Trang";
            let currentLat = 12.2388;
            let currentLon = 109.1967;
            let debounceTimer; // THÊM: Biến cho debounce
            let lastHourCheck = -1; // THÊM: Biến kiểm tra giờ cho theme 'auto'

            // --- THÊM MỚI: Logic xử lý Theme (Giao diện) ---
            let currentTheme = localStorage.getItem('theme') || 'system';
            const systemThemeMatcher = window.matchMedia('(prefers-color-scheme: dark)');
            const themeLabels = {
                'light': 'Sáng',
                'dark': 'Tối',
                'system': 'Hệ thống',
                'auto': 'Theo đồng hồ'
            };

            // Cập nhật dấu check và nhãn
            function updateThemeUI(selectedTheme) {
                currentThemeLabel.textContent = themeLabels[selectedTheme];
                themeOptionButtons.forEach(button => {
                    const checkIcon = button.querySelector('.icon');
                    if (button.dataset.theme === selectedTheme) {
                        checkIcon.classList.remove('hidden');
                    } else {
                        checkIcon.classList.add('hidden');
                    }
                });
            }

            // Áp dụng theme (cốt lõi)
            function runThemeUpdate() {
                let themeToApply = currentTheme;

                if (currentTheme === 'system') {
                    themeToApply = systemThemeMatcher.matches ? 'dark' : 'light';
                }
                
                if (currentTheme === 'auto') {
                    const hour = new Date().getHours();
                    // 18:00 (6 PM) -> 5:59 (AM) là ban đêm
                    themeToApply = (hour >= 18 || hour < 6) ? 'dark' : 'light';
                }

                // Áp dụng class 'dark' vào thẻ <html>
                if (themeToApply === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            // Hàm chính khi chọn theme
            function applyTheme(theme) {
                currentTheme = theme;
                localStorage.setItem('theme', theme);
                updateThemeUI(theme);

                // Hủy listener cũ
                systemThemeMatcher.removeEventListener('change', runThemeUpdate);
                
                // Chạy cập nhật
                runThemeUpdate(); 
                
                // Thêm listener mới nếu là 'system'
                if (theme === 'system') {
                    systemThemeMatcher.addEventListener('change', runThemeUpdate);
                }
            }
            // --- Kết thúc Logic Theme ---


            // --- Cập nhật Đồng hồ ---
            function updateClock() {
                const now = new Date();
                const optionsDate = { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' };
                const dateString = now.toLocaleDateString('vi-VN', optionsDate);
                const timeString = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

                if (headerClock) headerClock.textContent = timeString;
                if (headerDate) headerDate.textContent = dateString;
                if (currentTimeDateEl) currentTimeDateEl.textContent = `${timeString} - ${dateString}`;

                // THÊM: Logic cập nhật theme "Theo đồng hồ"
                const currentHour = now.getHours();
                if (currentTheme === 'auto' && currentHour !== lastHourCheck) {
                    runThemeUpdate();
                    lastHourCheck = currentHour;
                }
            }

            // --- Điều chỉnh Chiều cao ---
            function adjustSectionHeights() {
                // SỬA: Toàn bộ hàm này đã được cập nhật
                requestAnimationFrame(() => {
                    const infoHeight = currentInfoSection.offsetHeight;
                    
                    if (window.innerWidth >= 1024) { // Chỉ áp dụng cho màn hình lg trở lên
                        const minHeight = `${infoHeight}px`;
                        hourlyForecastSection.style.minHeight = minHeight; // Sửa thành minHeight

                        // Reset style 'height' để Tailwind (lg:h-[360px]) có thể hoạt động
                        dailyForecastSection.style.height = '';
                        weatherMapSection.style.height = '';

                        // Điều chỉnh chiều cao của iframe bản đồ cho vừa vặn 360px
                        const mapTitle = weatherMapSection.querySelector('h2');
                        if (mapTitle) {
                            const mapTitleHeight = mapTitle.offsetHeight;
                            // p-6 (24px) padding top/bottom, mb-4 (16px) margin bottom h2
                            const paddingAndTitleHeight = (24 * 2) + 16 + mapTitleHeight; 
                            // Chiều cao cố định 360px trừ đi padding và tiêu đề
                            const newMapHeight = 360 - paddingAndTitleHeight;
                            
                            if (newMapHeight > 100) { // Đảm bảo chiều cao hợp lý
                                weatherMapEl.style.height = `${newMapHeight}px`;
                            } else {
                                weatherMapEl.style.height = `250px`; // Fallback
                            }
                        }

                    } else {
                        // Xóa chiều cao cố định trên di động
                        hourlyForecastSection.style.minHeight = 'auto'; // Sửa thành minHeight
                        dailyForecastSection.style.height = 'auto';
                        weatherMapSection.style.height = 'auto';
                        weatherMapEl.style.height = `250px`; // Reset
                    }
                });
            }

            // --- Hiển thị Lỗi ---
            function showError(message) {
                errorTextEl.textContent = message;
                errorMessageEl.classList.remove('hidden');
                setTimeout(() => {
                    errorMessageEl.classList.add('hidden');
                }, 3000);
            }

            // --- Lấy Biểu tượng & Mô tả Thời tiết ---
            function getWeatherIcon(code) {
                // Mã WMO -> Material Icons
                const icons = {
                    0: 'sunny', // Clear sky
                    1: 'partly_cloudy_day', // Mainly clear
                    2: 'partly_cloudy_day', // Partly cloudy
                    3: 'cloud', // Overcast
                    45: 'foggy', // Fog
                    48: 'foggy', // Depositing rime fog
                    51: 'rainy_light', // Drizzle light
                    53: 'rainy', // Drizzle moderate
                    55: 'rainy', // Drizzle dense
                    61: 'rainy', // Rain slight
                    63: 'rainy', // Rain moderate
                    65: 'rainy_heavy', // Rain heavy
                    71: 'weather_snowy', // Snow fall slight
                    73: 'weather_snowy', // Snow fall moderate
                    75: 'weather_snowy', // Snow fall heavy
                    80: 'thunderstorm', // Rain showers slight
                    81: 'thunderstorm', // Rain showers moderate
                    82: 'thunderstorm', // Rain showers violent
                    95: 'thunderstorm', // Thunderstorm
                };
                return icons[code] || 'thermostat'; // Mặc định
            }

            function getWeatherDescription(code) {
                const descriptions = {
                    0: 'Trời quang',
                    1: 'Gần quang',
                    2: 'Mây rải rác',
                    3: 'Trời u ám',
                    45: 'Sương mù',
                    48: 'Sương mù đọng',
                    51: 'Mưa phùn nhẹ',
                    53: 'Mưa phùn vừa',
                    55: 'Mưa phùn dày',
                    61: 'Mưa nhẹ',
                    63: 'Mưa vừa',
                    65: 'Mưa to',
                    71: 'Tuyết rơi nhẹ',
                    73: 'Tuyết rơi vừa',
                    75: 'Tuyết rơi dày',
                    80: 'Mưa rào nhẹ',
                    81: 'Mưa rào vừa',
                    82: 'Mưa rào dữ dội',
                    95: 'Dông',
                };
                return descriptions[code] || 'Không xác định';
            }
            
            function getUvDescription(uv) {
                if (uv <= 2) return `Thấp (${uv})`;
                if (uv <= 5) return `Vừa (${uv})`;
                if (uv <= 7) return `Cao (${uv})`;
                if (uv <= 10) return `Rất cao (${uv})`;
                return `Cực cao (${uv})`;
            }

            // --- THÊM: Lấy lớp nền (background) theo thời tiết ---
            // SỬA: Cập nhật hàm này để bao gồm thời gian trong ngày
            function getWeatherBackgroundClass(code) {
                const hour = new Date().getHours();
                let timeOfDay;
                let weatherType;

                // 1. Xác định thời gian trong ngày
                if (hour >= 5 && hour < 10) {
                    timeOfDay = 'morning'; // 5:00 - 9:59
                } else if (hour >= 10 && hour < 17) {
                    timeOfDay = 'day';     // 10:00 - 16:59
                } else if (hour >= 17 && hour < 20) {
                    timeOfDay = 'evening'; // 17:00 - 19:59
                } else {
                    timeOfDay = 'night';   // 20:00 - 4:59
                }

                // 2. Xác định loại thời tiết
                if (code <= 1) { // 0, 1
                    weatherType = 'sunny';
                } else if (code <= 3) { // 2, 3
                    weatherType = 'cloudy';
                } else if (code === 45 || code === 48) { // 45, 48
                    weatherType = 'foggy';
                } else if (code >= 71 && code <= 75) { // 71, 73, 75
                    weatherType = 'snowy';
                } else if (code >= 51) { // 5x, 6x, 8x, 9x
                    weatherType = 'rainy';
                } else {
                    weatherType = 'default';
                }

                // 3. Xử lý trường hợp đặc biệt
                if (timeOfDay === 'night' && weatherType === 'sunny') {
                    weatherType = 'clear'; // "Nắng" vào ban đêm là "Trời quang"
                }
                if (weatherType === 'default') {
                    return 'weather-default'; // Trả về mặc định nếu không khớp
                }

                // 4. Gộp và trả về tên lớp (ví dụ: "weather-day-sunny")
                return `weather-${timeOfDay}-${weatherType}`;
            }

            // --- Lấy dữ liệu thời tiết ---
            async function fetchWeather(lat, lon, city) {
                loadingSpinner.classList.remove('hidden');
                try {
                    const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relativehumidity_2m,weathercode,windspeed_10m,pressure_msl,dewpoint_2m,visibility,uv_index&hourly=temperature_2m,weathercode,temperature_80m,precipitation_probability&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=14`;
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('Không thể tải dữ liệu thời tiết.');
                    
                    const data = await response.json();
                    updateCurrentWeatherUI(data, city);
                    updateHourlyForecastUI(data);
                    updateDailyForecastUI(data);
                    
                    // Cập nhật bản đồ
                    weatherMapEl.src = `https://embed.windy.com/embed.html?type=map&location=coordinates&metricWind=kmh&metricTemp=°C&radarRange=-1&lat=${lat}&lon=${lon}&zoom=9`;

                    // Điều chỉnh chiều cao sau khi có dữ liệu
                    adjustSectionHeights();

                } catch (error) {
                    console.error('Lỗi khi lấy dữ liệu thời tiết:', error);
                    showError(error.message);
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }

            // --- Lấy tọa độ từ tên thành phố (cho submit) ---
            async function fetchCoordinates(city) {
                loadingSpinner.classList.remove('hidden');
                try {
                    const apiUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=vi&format=json`;
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('Không tìm thấy vị trí.');
                    
                    const data = await response.json();
                    if (!data.results || data.results.length === 0) {
                        throw new Error(`Không tìm thấy vị trí cho "${city}".`);
                    }
                    
                    const location = data.results[0];
                    const lat = location.latitude;
                    const lon = location.longitude;
                    // Xây dựng tên vị trí (ưu tiên Tỉnh/Thành phố, nếu không có thì dùng tên)
                    const admin1 = location.admin1 ? `, ${location.admin1}` : '';
                    const displayName = `${location.name}${admin1}`;

                    currentCity = displayName;
                    currentLat = lat;
                    currentLon = lon;

                    fetchWeather(lat, lon, displayName);

                } catch (error) {
                    console.error('Lỗi khi lấy tọa độ:', error);
                    showError(error.message);
                } finally {
                    loadingSpinner.classList.add('hidden');
                    searchSuggestionsEl.classList.add('hidden'); // Ẩn gợi ý
                }
            }
            
            // --- THÊM: Lấy gợi ý tìm kiếm ---
            async function fetchSuggestions(query) {
                if (query.length < 3) {
                    searchSuggestionsEl.classList.add('hidden');
                    return;
                }
                
                try {
                    const apiUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=10&language=vi&format=json`;
                    const response = await fetch(apiUrl);
                    if (!response.ok) return;
                    
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        displaySuggestions(data.results);
                    } else {
                        searchSuggestionsEl.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Lỗi khi lấy gợi ý:', error);
                    searchSuggestionsEl.classList.add('hidden');
                }
            }

            // --- THÊM: Hiển thị gợi ý tìm kiếm ---
            function displaySuggestions(results) {
                searchSuggestionsEl.innerHTML = '';
                if (results.length === 0) {
                    searchSuggestionsEl.classList.add('hidden');
                    return;
                }
                
                results.forEach(location => {
                    const admin1 = location.admin1 ? `, ${location.admin1}` : '';
                    const country = location.country ? `, ${location.country}` : '';
                    const displayName = `${location.name}${admin1}`;
                    const fullDisplayName = `${location.name}${admin1}${country}`;
                    
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = "p-4 hover:bg-slate-100 dark:hover:bg-slate-600 cursor-pointer flex items-center gap-3"; // SỬA: dark:
                    suggestionItem.innerHTML = `
                        <span class="icon text-slate-500 dark:text-slate-400">location_on</span> <!-- SỬA: dark: -->
                        <span>${fullDisplayName}</span>
                    `;
                    
                    suggestionItem.addEventListener('click', () => {
                        currentCity = displayName;
                        currentLat = location.latitude;
                        currentLon = location.longitude;
                        
                        fetchWeather(location.latitude, location.longitude, displayName);
                        
                        searchInput.value = '';
                        searchSuggestionsEl.classList.add('hidden');
                    });
                    
                    searchSuggestionsEl.appendChild(suggestionItem);
                });
                
                searchSuggestionsEl.classList.remove('hidden');
            }

            // --- Cập nhật Giao diện ---
            function updateCurrentWeatherUI(data, city) {
                const current = data.current;
                
                // THÊM: Cập nhật background body
                const weatherClass = getWeatherBackgroundClass(current.weathercode);
                
                // SỬA: Xóa tất cả các lớp weather- cũ
                // (Liệt kê tất cả các khả năng để đảm bảo xóa sạch)
                document.body.classList.remove(
                    'weather-default',
                    'weather-morning-sunny', 'weather-day-sunny', 'weather-evening-sunny', 'weather-night-clear',
                    'weather-morning-cloudy', 'weather-day-cloudy', 'weather-evening-cloudy', 'weather-night-cloudy',
                    'weather-morning-rainy', 'weather-day-rainy', 'weather-evening-rainy', 'weather-night-rainy',
                    'weather-morning-foggy', 'weather-day-foggy', 'weather-evening-foggy', 'weather-night-foggy',
                    'weather-morning-snowy', 'weather-day-snowy', 'weather-evening-snowy', 'weather-night-snowy'
                );
                // Thêm lớp mới
                document.body.classList.add(weatherClass);

                currentLocationEl.textContent = city;
                currentTempEl.textContent = `${Math.round(current.temperature_2m)}°C`;
                currentConditionEl.textContent = getWeatherDescription(current.weathercode);
                currentWeatherIconEl.textContent = getWeatherIcon(current.weathercode);
                
                currentWindEl.textContent = `${Math.round(current.windspeed_10m)} km/h`;
                currentPressureEl.textContent = `${Math.round(current.pressure_msl)} hPa`;
                currentHumidityEl.textContent = `${current.relativehumidity_2m}%`;
                currentVisibilityEl.textContent = `${Math.round(current.visibility / 1000)} km`;
                currentDewpointEl.textContent = `${Math.round(current.dewpoint_2m)}°C`;
                currentUvEl.textContent = getUvDescription(Math.round(current.uv_index));
            }

            function updateHourlyForecastUI(data) {
                hourlyForecastContainer.innerHTML = '';
                const now = new Date();
                const currentHour = now.getHours();

                let startIndex = data.hourly.time.findIndex(timeStr => new Date(timeStr).getHours() === currentHour);
                if (startIndex === -1) startIndex = 0; 

                for (let i = startIndex; i < startIndex + 24 && i < data.hourly.time.length; i++) {
                    const time = new Date(data.hourly.time[i]);
                    const hourString = time.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    
                    const tempLow = data.hourly.temperature_80m[i] ? Math.round(data.hourly.temperature_80m[i]) : Math.round(data.hourly.temperature_2m[i] - 2);

                    // SỬA: p-12 -> p-4 và w-33 -> w-40
                    const html = `
                        <div class="text-center flex-shrink-0 p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl w-40"> <!-- SỬA: dark: -->
                            <span class="icon text-3xl text-blue-500">${getWeatherIcon(data.hourly.weathercode[i])}</span>
                            <div class="my-1">
                                <span class="font-bold">${Math.round(data.hourly.temperature_2m[i])}°</span>
                                <span class="text-slate-600 dark:text-slate-400">${tempLow}°</span> <!-- SỬA: dark: -->
                            </div>
                            <div class="text-sm text-slate-700 dark:text-slate-300 mb-1 truncate">${getWeatherDescription(data.hourly.weathercode[i])}</div> <!-- SỬA: dark: -->
                            <div class="font-bold">${hourString}</div>
                        </div>
                    `;
                    hourlyForecastContainer.innerHTML += html;
                }
            }

            function updateDailyForecastUI(data) {
                // SỬA: Toàn bộ hàm này đã được cập nhật
                dailyForecastContainer.innerHTML = '';
                for (let i = 0; i < data.daily.time.length; i++) {
                    const date = new Date(data.daily.time[i]);
                    const dayMonth = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
                    const weekday = date.toLocaleDateString('vi-VN', { weekday: 'long' });
                    
                    const html = `
                        <!-- Thêm 'flex-shrink-0 w-40' cho di động và 'lg:w-full' cho desktop -->
                        <div class="flex-shrink-0 w-40 p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl lg:w-full"> <!-- SỬA: dark: -->
                        
                            <!-- Bố cục DI ĐỘNG (giống hàng giờ): ẩn trên 'lg' -->
                            <div class="flex flex-col items-center text-center lg:hidden">
                                <span class="icon text-3xl text-blue-500">${getWeatherIcon(data.daily.weathercode[i])}</span>
                                <div class="my-1">
                                    <span class="font-bold">${Math.round(data.daily.temperature_2m_max[i])}°</span>
                                    <span class="text-slate-600 dark:text-slate-400">/ ${Math.round(data.daily.temperature_2m_min[i])}°</span> <!-- SỬA: dark: -->
                                </div>
                                <div class="text-sm text-slate-700 dark:text-slate-300 truncate">${getWeatherDescription(data.daily.weathercode[i])}</div> <!-- SỬA: dark: -->
                                <div class="font-bold mt-1">${dayMonth}</div>
                            </div>
                            
                            <!-- Bố cục DESKTOP (như cũ): ẩn dưới 'lg' -->
                            <div class="hidden lg:block">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="font-bold">${dayMonth}</div>
                                    <div class="text-slate-600 dark:text-slate-400">${weekday}</div> <!-- SỬA: dark: -->
                                </div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="icon text-3xl text-blue-500">${getWeatherIcon(data.daily.weathercode[i])}</span>
                                    <div>
                                        <span class="font-bold text-lg">${Math.round(data.daily.temperature_2m_max[i])}°</span>
                                        <span class="text-slate-600 dark:text-slate-400">/ ${Math.round(data.daily.temperature_2m_min[i])}°</span> <!-- SỬA: dark: -->
                                    </div>
                                </div>
                                <div class="text-sm text-slate-700 dark:text-slate-300">${getWeatherDescription(data.daily.weathercode[i])}</div> <!-- SỬA: dark: -->
                            </div>
                        </div>
                    `;
                    dailyForecastContainer.innerHTML += html;
                }
            }

            // --- Xử lý sự kiện ---
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const city = searchInput.value.trim();
                if (city) {
                    fetchCoordinates(city);
                    searchInput.value = '';
                    searchSuggestionsEl.classList.add('hidden'); // THÊM
                }
            });

            // THÊM: Sự kiện gõ phím cho gợi ý
            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    fetchSuggestions(searchInput.value.trim());
                }, 300); // Đợi 300ms rồi mới gọi API
            });

            // THÊM: Ẩn gợi ý khi nhấp ra ngoài
            document.addEventListener('click', (e) => {
                if (!searchForm.contains(e.target)) {
                    searchSuggestionsEl.classList.add('hidden');
                }
                
                // THÊM MỚI: Ẩn menu Cài đặt khi nhấp ra ngoài
                if (settingsMenu && !settingsButton.contains(e.target) && !settingsMenu.contains(e.target)) {
                    settingsMenu.classList.add('hidden');
                    // Reset về menu chính
                    settingsMainView.classList.remove('hidden');
                    themeSubmenu.classList.add('hidden');
                }
            });


            // --- Khởi tạo ---
            // THÊM: Logic Khởi tạo Theme
            applyTheme(currentTheme); 
            lastHourCheck = new Date().getHours(); // Khởi tạo giờ kiểm tra

            setInterval(updateClock, 1000);
            updateClock();
            fetchWeather(currentLat, currentLon, currentCity); // Tải dữ liệu ban đầu cho Nha Trang

            // Theo dõi thay đổi kích thước cửa sổ
            window.addEventListener('resize', adjustSectionHeights);

            // --- THÊM MỚI: Xử lý Modal Bản đồ ---
            openMapModalBtn.addEventListener('click', () => {
                // Lấy lat/lon hiện tại và tạo URL chi tiết
                // (Sử dụng các tham số bạn cung cấp, nhưng với vĩ độ/kinh độ động)
                const modalMapUrl = `https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=default&metricWind=default&zoom=5&overlay=wind&product=ecmwf&level=surface&lat=${currentLat}&lon=${currentLon}&detailLat=${currentLat}&detailLon=${currentLon}&detail=true&pressure=true&message=true`;
                
                fullWeatherMapEl.src = modalMapUrl; // Đặt src cho iframe
                
                // SỬA: Thay đổi logic để dùng class animation
                mapModal.classList.add('modal-open'); 
            });
            
            closeMapModalBtn.addEventListener('click', () => {
                // SỬA: Thay đổi logic để dùng class animation
                mapModal.classList.remove('modal-open');
                
                fullWeatherMapEl.src = ''; // Dừng tải iframe khi đóng
            });

            // --- THÊM MỚI: Xử lý Menu Cài đặt ---
            settingsButton.addEventListener('click', () => {
                settingsMenu.classList.toggle('hidden');
            });

            themeMenuButton.addEventListener('click', () => {
                settingsMainView.classList.add('hidden');
                themeSubmenu.classList.remove('hidden');
            });

            themeMenuBack.addEventListener('click', () => {
                settingsMainView.classList.remove('hidden');
                themeSubmenu.classList.add('hidden');
            });

            themeOptionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedTheme = button.dataset.theme;
                    applyTheme(selectedTheme);
                });
            });
        });
    </script>

</body>
</html>
