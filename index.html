<!DOCTYPE html>
<html lang="vi" class=""> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Thời tiết</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        window.onload = function() {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    darkMode: 'class',
                    theme: {
                        extend: {
                            fontFamily: { sans: ['Inter', 'sans-serif'] },
                            animation: { 'spin-slow': 'spin 10s linear infinite' }
                        },
                    },
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background 0.5s ease-in-out;
            position: relative;
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(150, 150, 150, 0.4); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(150, 150, 150, 0.6); }

        /* Weather Backgrounds */
        .weather-default { background: linear-gradient(to top, #d2d6db, #f9fafb); }
        html.dark .weather-default { background: linear-gradient(to top, #334155, #0f172a); }

        .weather-day-sunny { background: linear-gradient(to bottom, #87CEEB, #f0f8ff); }
        .weather-day-cloudy { background: linear-gradient(to bottom, #B0C4DE, #f0f8ff); }
        .weather-day-rainy, .weather-day-snowy, .weather-day-foggy { background: linear-gradient(to bottom, #4b79a1, #8e9eab); }
        
        .weather-morning-sunny { background: linear-gradient(to bottom, #FFDAB9, #E6E6FA); }
        .weather-morning-cloudy { background: linear-gradient(to bottom, #D8BFD8, #E6E6FA); }
        .weather-morning-rainy, .weather-morning-snowy, .weather-morning-foggy { background: linear-gradient(to bottom, #6190E8, #A7BFE8); }
        
        .weather-evening-sunny { background: linear-gradient(to bottom, #FF7F50, #4682B4); }
        .weather-evening-cloudy { background: linear-gradient(to bottom, #6A5ACD, #4682B4); }
        .weather-evening-rainy, .weather-evening-snowy, .weather-evening-foggy { background: linear-gradient(to bottom, #1c3b68, #4ca1af); }
        
        .weather-night-clear { background: linear-gradient(to bottom, #000080, #191970); }
        .weather-night-cloudy { background: linear-gradient(to bottom, #2F4F4F, #1E1E1E); }
        .weather-night-rainy, .weather-night-snowy, .weather-night-foggy { background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.25); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            transition: all 0.3s ease;
        }
        html.dark .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-item {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        html.dark .glass-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Effects - Fix Black Artifacts */
        #weather-effects-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; overflow: hidden; }
        
        .rain-drop { 
            position: absolute; background: rgba(255,255,255,0.6); 
            width: 2px; height: 25px; top: -25px; animation: fall linear infinite; 
        }
        @keyframes fall { to { transform: translateY(110vh); } }

        /* Simplified Sun Effects to avoid black rendering */
        .sun-glare {
            position: absolute; top: -100px; right: -100px; width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%; pointer-events: none;
        }
        
        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; opacity: 0; }
        .modal-entering { animation: modalZoomIn 0.2s ease-out forwards; }
        .modal-exiting { animation: modalZoomOut 0.2s ease-out forwards; }
        @keyframes modalZoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes modalZoomOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
    </style>
</head>

<body class="weather-default text-slate-800 dark:text-slate-200 px-4 md:px-8 pb-28 pt-16 md:pt-28 md:pb-8 min-h-screen">

    <!-- Effects Layer -->
    <div id="weather-effects-container"></div>

    <!-- Main Content -->
    <div class="max-w-screen-2xl mx-auto relative z-10">
        
        <!-- HEADER -->
        <header class="fixed inset-0 z-50 pointer-events-none flex flex-col justify-between 
                       md:pointer-events-auto md:fixed md:inset-auto md:top-0 md:left-0 md:right-0 md:h-auto 
                       md:grid md:grid-cols-3 md:items-center md:gap-4 md:p-8 md:max-w-screen-2xl md:mx-auto md:bg-transparent 
                       transition-all duration-300">
            
            <!-- Left: Clock (Desktop) / Top (Mobile) -->
            <div class="pointer-events-auto pt-6 flex justify-center items-center gap-3 
                        md:pt-0 md:block md:text-left md:col-span-1 drop-shadow-md">
                <div id="header-clock" class="text-2xl md:text-3xl font-bold text-white tracking-tight">--:--</div>
                <span class="md:hidden text-white/60 text-xl">|</span>
                <div id="header-date" class="text-sm text-white/90 font-medium">...</div>
            </div>
            
            <!-- Center: Controls (Desktop) / Bottom (Mobile) -->
            <div class="pointer-events-auto p-4 pb-6 w-full flex items-center gap-3 bg-transparent md:contents md:p-0">
                <div class="flex flex-1 items-center gap-3 md:col-span-1 md:justify-center md:w-full">
                    <button id="detect-location-button" class="flex-none bg-white/90 dark:bg-slate-700/90 p-3 rounded-full shadow-lg hover:scale-110 transition-transform active:scale-95 backdrop-blur-sm text-blue-600 dark:text-blue-400">
                        <span class="material-symbols-rounded w-6 h-6">my_location</span>
                    </button>

                    <form id="search-form" class="w-full max-w-md relative group flex-1">
                        <div class="relative">
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                                <span class="material-symbols-rounded text-xl">search</span>
                            </div>
                            <input type="text" id="search-input" placeholder="Tìm kiếm..." 
                                   class="w-full bg-white/90 dark:bg-slate-800/90 shadow-lg rounded-full py-3 px-12 
                                          focus:outline-none focus:ring-2 focus:ring-blue-500/50 backdrop-blur-sm
                                          transition-all duration-300 group-hover:shadow-xl">
                        </div>
                        <div id="search-suggestions" class="hidden absolute z-50 w-full bg-white/95 dark:bg-slate-800/95 rounded-2xl shadow-2xl overflow-hidden backdrop-blur-md border border-slate-100 dark:border-slate-700
                            bottom-full mb-3 md:bottom-auto md:mb-0 md:top-full md:mt-2">
                        </div>
                    </form>
                </div>
                
                <!-- Right: Settings -->
                <div class="flex-none md:col-span-1 md:flex md:justify-end">
                    <button id="settings-button" class="bg-white/90 dark:bg-slate-700/90 p-3 rounded-full shadow-lg hover:scale-110 transition-transform active:scale-95 backdrop-blur-sm">
                        <span class="material-symbols-rounded w-6 h-6 text-slate-700 dark:text-slate-200">settings</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- GRID CONTENT -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- LEFT COLUMN -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- Current Info -->
                <section id="current-info-section" class="glass-panel rounded-[2rem] p-8 shadow-lg animate-slide-up delay-100">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h1 id="current-location" class="text-3xl md:text-4xl font-bold tracking-tight drop-shadow-sm">Đang tải...</h1>
                            <p id="current-time-date" class="text-slate-600 dark:text-slate-300 font-medium mt-1">...</p>
                        </div>
                        <div id="loading-spinner" class="hidden animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                    <div class="flex items-center gap-6 mb-8">
                        <!-- Icon Container -->
                        <div id="current-weather-icon-container" class="w-32 h-32 drop-shadow-2xl filter animate-slide-up"></div>
                        <div>
                            <div id="current-temp" class="text-7xl md:text-8xl font-bold tracking-tighter drop-shadow-sm">--°</div>
                            <div id="current-condition" class="text-xl md:text-2xl text-slate-700 dark:text-slate-200 font-medium">...</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="glass-item flex items-center gap-3 p-3 rounded-xl"><span class="material-symbols-rounded text-blue-500">air</span><div><div class="text-xs opacity-70">Gió</div><div id="current-wind" class="font-bold">--</div></div></div>
                        <div class="glass-item flex items-center gap-3 p-3 rounded-xl"><span class="material-symbols-rounded text-blue-500">compress</span><div><div class="text-xs opacity-70">Áp suất</div><div id="current-pressure" class="font-bold">--</div></div></div>
                        <div class="glass-item flex items-center gap-3 p-3 rounded-xl"><span class="material-symbols-rounded text-blue-500">water_drop</span><div><div class="text-xs opacity-70">Độ ẩm</div><div id="current-humidity" class="font-bold">--</div></div></div>
                        <div class="glass-item flex items-center gap-3 p-3 rounded-xl"><span class="material-symbols-rounded text-blue-500">visibility</span><div><div class="text-xs opacity-70">Tầm nhìn</div><div id="current-visibility" class="font-bold">--</div></div></div>
                        <div class="glass-item flex items-center gap-3 p-3 rounded-xl"><span class="material-symbols-rounded text-blue-500">dew_point</span><div><div class="text-xs opacity-70">Điểm sương</div><div id="current-dewpoint" class="font-bold">--</div></div></div>
                        <div class="glass-item flex items-center gap-3 p-3 rounded-xl"><span class="material-symbols-rounded text-orange-500">wb_sunny</span><div><div class="text-xs opacity-70">UV</div><div id="current-uv" class="font-bold">--</div></div></div>
                    </div>
                </section>
                
                <!-- Hourly -->
                <section class="glass-panel rounded-[2rem] p-6 shadow-lg animate-slide-up delay-200">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="material-symbols-rounded">schedule</span> Dự báo hàng giờ</h2>
                    <div id="hourly-forecast-container" class="flex gap-3 overflow-x-auto pb-4 cursor-grab active:cursor-grabbing custom-scrollbar"></div>
                </section>
            </div>
            
            <!-- RIGHT COLUMN -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- Daily -->
                <section class="glass-panel rounded-[2rem] p-6 shadow-lg lg:h-[400px] flex flex-col animate-slide-up delay-300">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="material-symbols-rounded">calendar_month</span> Dự báo 14 ngày</h2>
                    <div id="daily-forecast-container" class="flex gap-3 overflow-x-auto pb-2 lg:flex-col lg:overflow-y-auto lg:flex-1 lg:pr-2 custom-scrollbar"></div>
                </section>
                
                <!-- Map -->
                <section class="glass-panel rounded-[2rem] p-6 shadow-lg lg:h-[350px] flex flex-col animate-slide-up delay-400">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2"><span class="material-symbols-rounded">map</span> Bản đồ</h2>
                        <button id="map-details-button" class="flex items-center text-sm text-blue-600 dark:text-blue-400 font-bold hover:underline">Mở rộng <span class="material-symbols-rounded text-lg ml-1">open_in_full</span></button>
                    </div>
                    <iframe id="weather-map" class="w-full flex-1 rounded-xl border-0 shadow-inner bg-slate-200 dark:bg-slate-700" src="about:blank"></iframe>
                </section>
            </div>
            
            <!-- Details Full Width -->
            <section class="lg:col-span-2 glass-panel rounded-[2rem] p-8 shadow-lg animate-slide-up delay-500">
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2"><span class="material-symbols-rounded">tune</span> Chỉ số chi tiết</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Items detail... (Giữ nguyên cấu trúc cũ nhưng làm gọn code cho bạn dễ nhìn) -->
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-blue-500">thermostat</span><span class="text-sm opacity-70">Nhiệt độ</span></div><div id="detail-temp" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-blue-500">device_thermostat</span><span class="text-sm opacity-70">Cảm giác</span></div><div id="detail-feels-like" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-blue-500">cloud</span><span class="text-sm opacity-70">Mây phủ</span></div><div id="detail-cloud-cover" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-blue-500">rainy</span><span class="text-sm opacity-70">Lượng mưa</span></div><div id="detail-precipitation" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-blue-500">air</span><span class="text-sm opacity-70">Tốc độ gió</span></div><div id="detail-wind" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-blue-500">water_drop</span><span class="text-sm opacity-70">Độ ẩm</span></div><div id="detail-humidity" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-orange-500">wb_sunny</span><span class="text-sm opacity-70">Chỉ số UV</span></div><div id="detail-uv" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-green-500">aq_indoor</span><span class="text-sm opacity-70">AQI (KK)</span></div><div id="detail-aqi" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-blue-500">visibility</span><span class="text-sm opacity-70">Tầm nhìn</span></div><div id="detail-visibility" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-blue-500">compress</span><span class="text-sm opacity-70">Áp suất</span></div><div id="detail-pressure" class="text-2xl font-bold">--</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-yellow-500">light_mode</span><span class="text-sm opacity-70">Mặt trời</span></div><div id="detail-sun" class="text-lg font-bold">-- / --</div></div>
                    <div class="glass-item p-4 rounded-2xl flex flex-col justify-between h-full"><div class="flex items-center gap-2 mb-2"><span class="material-symbols-rounded text-purple-400">dark_mode</span><span class="text-sm opacity-70">Mặt trăng</span></div><div id="detail-moon" class="text-lg font-bold">N/A</div></div>
                </div>
            </section>
        </main>
        
        <!-- Error Toast -->
        <div id="error-message" class="hidden fixed top-6 right-6 bg-red-500/90 backdrop-blur text-white p-4 rounded-xl shadow-2xl z-50 animate-slide-up flex items-center">
            <span class="material-symbols-rounded mr-2">warning</span><span id="error-text">Lỗi</span>
        </div>

        <!-- Modals (Map & Settings) -->
        <div id="map-modal" class="hidden fixed inset-0 bg-white/80 dark:bg-slate-900/90 backdrop-blur-md z-50 flex-col transition-opacity">
            <header class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-2xl font-bold">Bản đồ chi tiết</h2>
                <button id="map-close-button" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"><span class="material-symbols-rounded text-3xl">close</span></button>
            </header>
            <main class="flex-1 p-4"><iframe id="full-weather-map" class="w-full h-full rounded-2xl shadow-2xl" src="about:blank" frameborder="0"></iframe></main>
        </div>

        <div id="settings-menu-container" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 transition-opacity">
            <div id="settings-menu" class="absolute right-4 bottom-24 md:bottom-auto md:top-24 w-72 bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl rounded-3xl shadow-2xl p-5 border border-white/20">
                <div id="settings-main-menu">
                    <h3 class="font-bold text-lg mb-4 px-2">Cài đặt</h3>
                    <button id="theme-menu-button" class="w-full flex justify-between items-center p-3 rounded-xl hover:bg-slate-100/50 dark:hover:bg-slate-700/50 transition-colors">
                        <div class="flex items-center gap-3"><span class="material-symbols-rounded text-slate-500">palette</span><span>Giao diện</span></div>
                        <span class="material-symbols-rounded text-slate-400">chevron_right</span>
                    </button>
                </div>
                <div id="settings-theme-menu" class="hidden">
                    <div class="flex items-center mb-4">
                        <button id="theme-back-button" class="p-2 -ml-2 rounded-full hover:bg-slate-100/50 dark:hover:bg-slate-700/50 transition-colors"><span class="material-symbols-rounded">arrow_back</span></button>
                        <h3 class="font-bold text-lg ml-2">Giao diện</h3>
                    </div>
                    <div class="space-y-1">
                        <button data-theme="light" class="theme-option w-full text-left p-3 rounded-xl hover:bg-slate-100/50 dark:hover:bg-slate-700/50 transition-colors flex items-center gap-3"><span class="material-symbols-rounded">light_mode</span> Sáng</button>
                        <button data-theme="dark" class="theme-option w-full text-left p-3 rounded-xl hover:bg-slate-100/50 dark:hover:bg-slate-700/50 transition-colors flex items-center gap-3"><span class="material-symbols-rounded">dark_mode</span> Tối</button>
                        <button data-theme="system" class="theme-option w-full text-left p-3 rounded-xl hover:bg-slate-100/50 dark:hover:bg-slate-700/50 transition-colors flex items-center gap-3"><span class="material-symbols-rounded">settings_system_daydream</span> Hệ thống</button>
                        <button data-theme="clock" class="theme-option w-full text-left p-3 rounded-xl hover:bg-slate-100/50 dark:hover:bg-slate-700/50 transition-colors flex items-center gap-3"><span class="material-symbols-rounded">schedule</span> Theo giờ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- INLINE ICONS (SVG) - KHÔNG CẦN TẢI TỪ GITHUB ---
            const ICONS = {
                sun: `<svg viewBox="0 0 64 64" class="w-full h-full" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="14" fill="#FDB813"/><path d="M32 8V4M32 60V56M8 32H4M60 32H56M15.03 15.03L12.2 12.2M51.8 51.8L48.97 48.97M15.03 48.97L12.2 51.8M51.8 12.2L48.97 15.03" stroke="#FDB813" stroke-width="4" stroke-linecap="round"/></svg>`,
                moon: `<svg viewBox="0 0 64 64" class="w-full h-full" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M36.5 16.5C30 16.5 24.5 20.5 22.5 26.5C22.5 26.5 19.5 26.5 19.5 26.5C13.15 26.5 8 31.65 8 38C8 44.35 13.15 49.5 19.5 49.5H42.5C47.75 49.5 52 45.25 52 40C52 35.45 48.8 31.6 44.5 30.75C43.5 22.6 36.5 16.5 28 16.5" stroke="none"/><path d="M44.5 18C44.5 18 40.5 20 40.5 25.5C40.5 31 45 34.5 45 34.5C40.5 38 35 36.5 35 36.5C35 36.5 36 27 44.5 18Z" fill="#E2E8F0"/><path d="M46.5 38.5C46.5 38.5 42.5 40.5 42.5 46C42.5 51.5 47 55 47 55C42.5 58.5 37 57 37 57C37 57 38 47.5 46.5 38.5Z" fill="#E2E8F0" opacity="0"/></svg>`,
                cloud: `<svg viewBox="0 0 64 64" class="w-full h-full" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M46 42C50.4183 42 54 38.4183 54 34C54 29.5817 50.4183 26 46 26C45.67 26 45.35 26.03 45.03 26.07C43.95 19.78 38.48 15 32 15C24.82 15 19 20.82 19 28C19 28.54 19.03 29.07 19.1 29.58C14.96 30.65 12 34.44 12 39C12 44.52 16.48 49 22 49H46C50.41 49 54 45.86 54 42" fill="#E2E8F0" stroke="#94A3B8" stroke-width="2" stroke-linejoin="round"/></svg>`,
                rain: `<svg viewBox="0 0 64 64" class="w-full h-full" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M46 36C50.4183 36 54 32.4183 54 28C54 23.5817 50.4183 20 46 20C45.67 20 45.35 20.03 45.03 20.07C43.95 13.78 38.48 9 32 9C24.82 9 19 14.82 19 22C19 22.54 19.03 23.07 19.1 23.58C14.96 24.65 12 28.44 12 33C12 38.52 16.48 43 22 43H46C50.41 43 54 39.86 54 36" fill="#CBD5E1" stroke="#94A3B8" stroke-width="2"/><path d="M24 48V56M32 48V56M40 48V56" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/></svg>`,
                snow: `<svg viewBox="0 0 64 64" class="w-full h-full" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M46 36C50.4183 36 54 32.4183 54 28C54 23.5817 50.4183 20 46 20C45.67 20 45.35 20.03 45.03 20.07C43.95 13.78 38.48 9 32 9C24.82 9 19 14.82 19 22C19 22.54 19.03 23.07 19.1 23.58C14.96 24.65 12 28.44 12 33C12 38.52 16.48 43 22 43H46C50.41 43 54 39.86 54 36" fill="#F1F5F9" stroke="#CBD5E1" stroke-width="2"/><circle cx="24" cy="52" r="2" fill="#BFDBFE"/><circle cx="32" cy="52" r="2" fill="#BFDBFE"/><circle cx="40" cy="52" r="2" fill="#BFDBFE"/></svg>`,
                thunder: `<svg viewBox="0 0 64 64" class="w-full h-full" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M46 36C50.4183 36 54 32.4183 54 28C54 23.5817 50.4183 20 46 20C45.67 20 45.35 20.03 45.03 20.07C43.95 13.78 38.48 9 32 9C24.82 9 19 14.82 19 22C19 22.54 19.03 23.07 19.1 23.58C14.96 24.65 12 28.44 12 33C12 38.52 16.48 43 22 43H46" fill="#64748B" stroke="#475569" stroke-width="2"/><path d="M34 38L26 48H32L28 58" stroke="#FDB813" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>`
            };

            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const searchSuggestions = document.getElementById('search-suggestions');
            const headerClock = document.getElementById('header-clock');
            const headerDate = document.getElementById('header-date');
            const currentLocationEl = document.getElementById('current-location');
            const currentTimeDateEl = document.getElementById('current-time-date');
            const currentTempEl = document.getElementById('current-temp');
            const currentConditionEl = document.getElementById('current-condition');
            const currentWeatherIconContainer = document.getElementById('current-weather-icon-container');
            const hourlyForecastContainer = document.getElementById('hourly-forecast-container');
            const dailyForecastContainer = document.getElementById('daily-forecast-container');
            const weatherMapEl = document.getElementById('weather-map');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessageEl = document.getElementById('error-message');
            const errorTextEl = document.getElementById('error-text');
            const mapModal = document.getElementById('map-modal');
            const mapDetailsButton = document.getElementById('map-details-button');
            const mapCloseButton = document.getElementById('map-close-button');
            const fullWeatherMap = document.getElementById('full-weather-map');
            const detectLocationButton = document.getElementById('detect-location-button');
            const settingsButton = document.getElementById('settings-button');
            const weatherEffectsContainer = document.getElementById('weather-effects-container');

            let currentCity = "Nha Trang";
            let currentTheme = localStorage.getItem('theme') || 'system';
            let searchTimeout;

            // --- ICON LOGIC (INLINE) ---
            function getWeatherIconSVG(code, hour) {
                const isNight = (hour >= 18 || hour < 6);
                // WMO Codes
                if (code <= 1) return isNight ? ICONS.moon : ICONS.sun;
                if (code <= 3) return ICONS.cloud;
                if (code <= 48) return ICONS.cloud; // Fog
                if (code <= 67) return ICONS.rain;
                if (code >= 95) return ICONS.thunder;
                if (code >= 71 && code <= 77) return ICONS.snow;
                if (code >= 80) return ICONS.rain;
                return ICONS.cloud; // Default
            }

            function renderWeatherEffects(weatherCode, isDay) {
                weatherEffectsContainer.innerHTML = ''; 
                // Rain
                if ((weatherCode >= 51 && weatherCode <= 67) || (weatherCode >= 80 && weatherCode <= 82) || weatherCode >= 95) {
                    const rainCount = 60; // Reduced count for performance
                    for (let i = 0; i < rainCount; i++) {
                        const drop = document.createElement('div');
                        drop.classList.add('rain-drop');
                        drop.style.left = Math.random() * 100 + 'vw';
                        drop.style.animationDuration = Math.random() * 1 + 0.5 + 's';
                        drop.style.animationDelay = Math.random() * 2 + 's';
                        weatherEffectsContainer.appendChild(drop);
                    }
                }
                // Thunder
                if (weatherCode >= 95) {
                    const thunder = document.createElement('div');
                    thunder.classList.add('thunder-flash');
                    setInterval(() => {
                        if(Math.random() > 0.7) {
                            thunder.style.animation = 'none';
                            thunder.offsetHeight; 
                            thunder.style.animation = 'flash 0.5s ease-out';
                        }
                    }, 5000); // Slower interval
                    weatherEffectsContainer.appendChild(thunder);
                }
                // Sun Glare (Only Day & Clear)
                if (isDay && weatherCode <= 1) {
                     const glare = document.createElement('div');
                     glare.classList.add('sun-glare');
                     weatherEffectsContainer.appendChild(glare);
                }
            }

            function animateCountUp(el, targetValue, unit = '', duration = 1000) {
                const target = Math.round(targetValue);
                if (isNaN(target)) {
                    el.textContent = typeof targetValue === 'string' ? targetValue : `${targetValue}${unit}`;
                    return;
                }
                el.textContent = `${target}${unit}`;
            }

            function applyTheme(theme) {
                const hour = new Date().getHours();
                const isDark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) || (theme === 'clock' && (hour >= 18 || hour < 6));
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }

            function updateClock() {
                const now = new Date();
                headerClock.textContent = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                headerDate.textContent = now.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' });
                if (currentTimeDateEl) currentTimeDateEl.textContent = `${headerClock.textContent} - ${headerDate.textContent}`;
                if (currentTheme === 'clock') applyTheme('clock');
            }

            function showError(msg) {
                errorTextEl.textContent = msg;
                errorMessageEl.classList.remove('hidden');
                setTimeout(() => errorMessageEl.classList.add('hidden'), 4000);
            }

            function getWeatherDescription(code) {
                const desc = {
                    0:'Trời quang',1:'Ít mây',2:'Mây rải rác',3:'Nhiều mây',
                    45:'Sương mù',48:'Sương muối',51:'Mưa phùn nhẹ',53:'Mưa phùn',55:'Mưa phùn dày',
                    61:'Mưa nhỏ',63:'Mưa vừa',65:'Mưa to',71:'Tuyết rơi nhẹ',73:'Tuyết rơi',75:'Tuyết rơi dày',
                    80:'Mưa rào nhẹ',81:'Mưa rào',82:'Mưa rất to',95:'Dông',96:'Dông mưa đá',99:'Dông nặng'
                };
                return desc[code] || 'Không xác định';
            }

            function getWeatherBackgroundClass(code) {
                const hour = new Date().getHours();
                let time = (hour >= 5 && hour < 10) ? 'morning' : (hour >= 10 && hour < 17) ? 'day' : (hour >= 17 && hour < 20) ? 'evening' : 'night';
                let type = 'cloudy';
                if (code <= 1) type = 'sunny';
                else if (code <= 3) type = 'cloudy';
                else if (code <= 48) type = 'foggy';
                else if (code <= 67 || code >= 80) type = 'rainy';
                else if (code >= 71) type = 'snowy';
                if (time === 'night' && type === 'sunny') type = 'clear';
                if (['foggy', 'snowy'].includes(type)) type = 'rainy';
                return `weather-${time}-${type}`;
            }

            async function fetchLocationName(lat, lon) {
                try {
                    const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=vi`);
                    if(!res.ok) throw new Error();
                    const data = await res.json();
                    let name = '';
                    if (data.localityInfo?.administrative) {
                        const admin = data.localityInfo.administrative.sort((a, b) => b.adminLevel - a.adminLevel);
                        const local = admin.find(i => i.adminLevel >= 8) || admin[0];
                        const district = admin.find(i => i.adminLevel === 6);
                        const prov = admin.find(i => i.adminLevel === 4);
                        const parts = [local?.name, district?.name !== local?.name ? district?.name : null, prov?.name !== district?.name ? prov?.name : null].filter(Boolean);
                        name = parts.length > 2 ? `${parts[0]}, ${parts[1]}` : parts.join(', ');
                    } else {
                        name = [data.locality, data.city, data.principalSubdivision].filter(Boolean).join(', ');
                    }
                    currentCity = name || "Vị trí không xác định";
                    currentLat = lat; currentLon = lon;
                    fetchWeather(lat, lon, currentCity);
                    fetchAQI(lat, lon);
                } catch(e) { 
                    console.error(e);
                    showError('Không thể lấy tên địa điểm.');
                    loadingSpinner.classList.add('hidden');
                }
            }

            async function fetchAQI(lat, lon) {
                try {
                    const res = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi`);
                    const data = await res.json();
                    document.getElementById('detail-aqi').textContent = data.current?.us_aqi || '--';
                } catch(e) { console.error(e); }
            }

            async function fetchWeather(lat, lon, city) {
                loadingSpinner.classList.remove('hidden');
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relativehumidity_2m,weathercode,windspeed_10m,pressure_msl,dewpoint_2m,visibility,uv_index,apparent_temperature,cloudcover,precipitation&hourly=temperature_2m,weathercode,temperature_80m,precipitation_probability&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto&forecast_days=14`);
                    if(!res.ok) throw new Error('Lỗi tải thời tiết');
                    const data = await res.json();
                    updateUI(data, city);
                    weatherMapEl.src = `https://embed.windy.com/embed.html?type=map&location=coordinates&metricWind=kmh&metricTemp=°C&radarRange=-1&lat=${lat}&lon=${lon}&zoom=9`;
                } catch(e) {
                    showError(e.message);
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }

            function updateUI(data, city) {
                const cur = data.current;
                const hour = new Date().getHours();
                
                currentLocationEl.textContent = city;
                animateCountUp(currentTempEl, cur.temperature_2m, '°');
                currentConditionEl.textContent = getWeatherDescription(cur.weathercode);
                
                // USE INLINE SVG HERE
                currentWeatherIconContainer.innerHTML = getWeatherIconSVG(cur.weathercode, hour);
                
                const details = {
                    'current-wind': [cur.windspeed_10m, ' km/h'],
                    'current-pressure': [cur.pressure_msl, ' hPa'],
                    'current-humidity': [cur.relativehumidity_2m, '%'],
                    'current-visibility': [cur.visibility/1000, ' km'],
                    'current-dewpoint': [cur.dewpoint_2m, '°'],
                    'current-uv': [Math.round(cur.uv_index), ''],
                    'detail-temp': [cur.temperature_2m, '°C'],
                    'detail-feels-like': [cur.apparent_temperature, '°C'],
                    'detail-cloud-cover': [cur.cloudcover, '%'],
                    'detail-precipitation': [cur.precipitation, ' mm'],
                    'detail-wind': [cur.windspeed_10m, ' km/h'],
                    'detail-humidity': [cur.relativehumidity_2m, '%'],
                    'detail-uv': [Math.round(cur.uv_index), ''],
                    'detail-visibility': [cur.visibility/1000, ' km'],
                    'detail-pressure': [cur.pressure_msl, ' hPa'],
                };
                for(const [id, [val, unit]] of Object.entries(details)) {
                    const el = document.getElementById(id);
                    if(el) animateCountUp(el, val, unit);
                }

                const today = data.daily;
                const sunrise = new Date(today.sunrise[0]).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
                const sunset = new Date(today.sunset[0]).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
                document.getElementById('detail-sun').textContent = `${sunrise} / ${sunset}`;

                document.body.className = `text-slate-800 dark:text-slate-200 px-4 md:px-8 pb-28 pt-16 md:pt-28 md:pb-8 min-h-screen ${getWeatherBackgroundClass(cur.weathercode)}`;
                renderWeatherEffects(cur.weathercode, hour >= 6 && hour < 18);

                hourlyForecastContainer.innerHTML = '';
                const startIdx = data.hourly.time.findIndex(t => new Date(t).getHours() === hour) || 0;
                for(let i=startIdx; i<startIdx+24 && i<data.hourly.time.length; i++) {
                    const time = new Date(data.hourly.time[i]);
                    const hCode = data.hourly.weathercode[i];
                    const hTemp = Math.round(data.hourly.temperature_2m[i]);
                    
                    // Create element with Inline SVG
                    const div = document.createElement('div');
                    div.className = "glass-item min-w-[6rem] p-3 rounded-2xl text-center flex flex-col items-center justify-center";
                    div.innerHTML = `
                        <div class="text-sm font-bold mb-1">${time.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'})}</div>
                        <div class="w-10 h-10 my-1">${getWeatherIconSVG(hCode, time.getHours())}</div>
                        <div class="font-bold text-lg">${hTemp}°</div>
                        <div class="text-xs opacity-80 whitespace-normal leading-tight mb-1">${getWeatherDescription(hCode)}</div>
                        <div class="text-xs opacity-60">${data.hourly.precipitation_probability[i]}% mưa</div>
                    `;
                    hourlyForecastContainer.appendChild(div);
                }

                dailyForecastContainer.innerHTML = '';
                for(let i=0; i<data.daily.time.length; i++) {
                    const date = new Date(data.daily.time[i]);
                    const dCode = data.daily.weathercode[i];
                    const max = Math.round(data.daily.temperature_2m_max[i]);
                    const min = Math.round(data.daily.temperature_2m_min[i]);
                    
                    const div = document.createElement('div');
                    div.className = "glass-item p-3 rounded-2xl flex items-center justify-between gap-3 min-w-[180px]";
                    div.innerHTML = `
                        <div class="text-center w-14">
                            <div class="font-bold">${date.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit'})}</div>
                            <div class="text-xs opacity-70">${date.toLocaleDateString('vi-VN',{weekday:'short'})}</div>
                        </div>
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 mb-1">${getWeatherIconSVG(dCode, 12)}</div>
                            <div class="text-xs text-center font-medium whitespace-normal leading-tight">${getWeatherDescription(dCode)}</div>
                        </div>
                        <div class="text-right w-12">
                            <div class="font-bold">${max}°</div>
                            <div class="text-xs opacity-70">${min}°</div>
                        </div>
                    `;
                    dailyForecastContainer.appendChild(div);
                }
            }

            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const q = searchInput.value.trim();
                if(q) fetchCoordinates(q);
            });
            
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const q = searchInput.value.trim();
                if(q.length >= 2) searchTimeout = setTimeout(() => fetchSuggestions(q), 400);
                else searchSuggestions.classList.add('hidden');
            });

            async function fetchSuggestions(q) {
                try {
                    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=20&language=vi&format=json`);
                    const data = await res.json();
                    if(!data.results) return searchSuggestions.classList.add('hidden');
                    
                    const valid = data.results.filter(i => i.feature_code && (i.feature_code.startsWith('P') || i.feature_code.startsWith('A')));
                    const unique = [];
                    const seen = new Set();
                    valid.forEach(i => {
                        const k = `${i.name}-${i.admin1}-${i.country}`;
                        if(!seen.has(k)) { seen.add(k); unique.push(i); }
                    });
                    searchSuggestions.innerHTML = '';
                    unique.slice(0,8).forEach(loc => {
                        const div = document.createElement('div');
                        div.className = "p-3 hover:bg-blue-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700 last:border-0 text-sm";
                        div.innerHTML = `<div class="font-bold">${loc.name}</div><div class="text-xs opacity-70">${[loc.admin1, loc.country].filter(Boolean).join(', ')}</div>`;
                        div.onclick = () => {
                            currentCity = `${loc.name}, ${loc.admin1 || loc.country}`;
                            currentLat = loc.latitude; currentLon = loc.longitude;
                            fetchWeather(currentLat, currentLon, currentCity);
                            fetchAQI(currentLat, currentLon);
                            searchSuggestions.classList.add('hidden');
                            searchInput.value = '';
                        };
                        searchSuggestions.appendChild(div);
                    });
                    if (unique.length > 0) searchSuggestions.classList.remove('hidden');
                    else searchSuggestions.classList.add('hidden');
                } catch(e) { console.error(e); }
            }

            async function fetchCoordinates(q) {
                try {
                    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=10&language=vi&format=json`);
                    const data = await res.json();
                    const valid = data.results?.filter(i => i.feature_code && (i.feature_code.startsWith('P') || i.feature_code.startsWith('A'))) || [];
                    const loc = valid[0];
                    if(loc) {
                        currentCity = `${loc.name}, ${loc.admin1 || loc.country}`;
                        currentLat = loc.latitude; currentLon = loc.longitude;
                        fetchWeather(currentLat, currentLon, currentCity);
                        fetchAQI(currentLat, currentLon);
                        searchSuggestions.classList.add('hidden');
                    } else showError('Không tìm thấy địa điểm phù hợp.');
                } catch(e) { showError('Lỗi tìm kiếm.'); }
            }

            detectLocationButton.onclick = () => {
                if('geolocation' in navigator) {
                    loadingSpinner.classList.remove('hidden');
                    navigator.geolocation.getCurrentPosition(
                        pos => fetchLocationName(pos.coords.latitude, pos.coords.longitude),
                        () => { showError('Lỗi định vị.'); loadingSpinner.classList.add('hidden'); }
                    );
                }
            };

            // Menu Logic
            document.getElementById('settings-menu-container').onclick = (e) => {
                if(e.target === document.getElementById('settings-menu-container')) {
                    document.getElementById('settings-menu-container').classList.add('hidden');
                    document.getElementById('settings-main-menu').classList.remove('hidden');
                    document.getElementById('settings-theme-menu').classList.add('hidden');
                }
            };
            settingsButton.onclick = () => document.getElementById('settings-menu-container').classList.remove('hidden');
            document.getElementById('theme-menu-button').onclick = () => {
                document.getElementById('settings-main-menu').classList.add('hidden');
                document.getElementById('settings-theme-menu').classList.remove('hidden');
            };
            document.getElementById('theme-back-button').onclick = () => {
                document.getElementById('settings-main-menu').classList.remove('hidden');
                document.getElementById('settings-theme-menu').classList.add('hidden');
            };
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.onclick = () => {
                    currentTheme = btn.dataset.theme;
                    localStorage.setItem('theme', currentTheme);
                    applyTheme(currentTheme);
                    document.getElementById('settings-menu-container').classList.add('hidden');
                }
            });

            mapDetailsButton.onclick = () => {
                fullWeatherMap.src = weatherMapEl.src.replace('zoom=9', 'zoom=5') + '&detail=true&pressure=true';
                mapModal.classList.remove('hidden');
                mapModal.classList.remove('modal-exiting');
                mapModal.classList.add('modal-entering');
            };
            mapCloseButton.onclick = () => {
                mapModal.classList.remove('modal-entering');
                mapModal.classList.add('modal-exiting');
                setTimeout(() => {
                    mapModal.classList.add('hidden');
                    fullWeatherMap.src = 'about:blank';
                }, 200);
            };
            document.addEventListener('click', (e) => {
                if(!searchForm.contains(e.target)) searchSuggestions.classList.add('hidden');
            });

            applyTheme(currentTheme);
            setInterval(updateClock, 1000);
            updateClock();
            detectLocationButton.click(); 
        });
    </script>
</body>
</html>
